{"version":3,"file":"livekit-client.e2ee.worker.mjs","sources":["../node_modules/loglevel/lib/loglevel.js","../src/logger.ts","../src/e2ee/constants.ts","../src/room/errors.ts","../src/e2ee/errors.ts","../src/e2ee/events.ts","../node_modules/events/events.js","../src/room/track/options.ts","../src/e2ee/utils.ts","../src/e2ee/worker/SifGuard.ts","../src/e2ee/worker/FrameCryptor.ts","../src/e2ee/worker/ParticipantKeyHandler.ts","../src/e2ee/worker/e2ee.worker.ts"],"sourcesContent":["/*\n* loglevel - https://github.com/pimterry/loglevel\n*\n* Copyright (c) 2013 Tim Perry\n* Licensed under the MIT license.\n*/\n(function (root, definition) {\n    \"use strict\";\n    if (typeof define === 'function' && define.amd) {\n        define(definition);\n    } else if (typeof module === 'object' && module.exports) {\n        module.exports = definition();\n    } else {\n        root.log = definition();\n    }\n}(this, function () {\n    \"use strict\";\n\n    // Slightly dubious tricks to cut down minimized file size\n    var noop = function() {};\n    var undefinedType = \"undefined\";\n    var isIE = (typeof window !== undefinedType) && (typeof window.navigator !== undefinedType) && (\n        /Trident\\/|MSIE /.test(window.navigator.userAgent)\n    );\n\n    var logMethods = [\n        \"trace\",\n        \"debug\",\n        \"info\",\n        \"warn\",\n        \"error\"\n    ];\n\n    // Cross-browser bind equivalent that works at least back to IE6\n    function bindMethod(obj, methodName) {\n        var method = obj[methodName];\n        if (typeof method.bind === 'function') {\n            return method.bind(obj);\n        } else {\n            try {\n                return Function.prototype.bind.call(method, obj);\n            } catch (e) {\n                // Missing bind shim or IE8 + Modernizr, fallback to wrapping\n                return function() {\n                    return Function.prototype.apply.apply(method, [obj, arguments]);\n                };\n            }\n        }\n    }\n\n    // Trace() doesn't print the message in IE, so for that case we need to wrap it\n    function traceForIE() {\n        if (console.log) {\n            if (console.log.apply) {\n                console.log.apply(console, arguments);\n            } else {\n                // In old IE, native console methods themselves don't have apply().\n                Function.prototype.apply.apply(console.log, [console, arguments]);\n            }\n        }\n        if (console.trace) console.trace();\n    }\n\n    // Build the best logging method possible for this env\n    // Wherever possible we want to bind, not wrap, to preserve stack traces\n    function realMethod(methodName) {\n        if (methodName === 'debug') {\n            methodName = 'log';\n        }\n\n        if (typeof console === undefinedType) {\n            return false; // No method possible, for now - fixed later by enableLoggingWhenConsoleArrives\n        } else if (methodName === 'trace' && isIE) {\n            return traceForIE;\n        } else if (console[methodName] !== undefined) {\n            return bindMethod(console, methodName);\n        } else if (console.log !== undefined) {\n            return bindMethod(console, 'log');\n        } else {\n            return noop;\n        }\n    }\n\n    // These private functions always need `this` to be set properly\n\n    function replaceLoggingMethods(level, loggerName) {\n        /*jshint validthis:true */\n        for (var i = 0; i < logMethods.length; i++) {\n            var methodName = logMethods[i];\n            this[methodName] = (i < level) ?\n                noop :\n                this.methodFactory(methodName, level, loggerName);\n        }\n\n        // Define log.log as an alias for log.debug\n        this.log = this.debug;\n    }\n\n    // In old IE versions, the console isn't present until you first open it.\n    // We build realMethod() replacements here that regenerate logging methods\n    function enableLoggingWhenConsoleArrives(methodName, level, loggerName) {\n        return function () {\n            if (typeof console !== undefinedType) {\n                replaceLoggingMethods.call(this, level, loggerName);\n                this[methodName].apply(this, arguments);\n            }\n        };\n    }\n\n    // By default, we use closely bound real methods wherever possible, and\n    // otherwise we wait for a console to appear, and then try again.\n    function defaultMethodFactory(methodName, level, loggerName) {\n        /*jshint validthis:true */\n        return realMethod(methodName) ||\n               enableLoggingWhenConsoleArrives.apply(this, arguments);\n    }\n\n    function Logger(name, defaultLevel, factory) {\n      var self = this;\n      var currentLevel;\n      defaultLevel = defaultLevel == null ? \"WARN\" : defaultLevel;\n\n      var storageKey = \"loglevel\";\n      if (typeof name === \"string\") {\n        storageKey += \":\" + name;\n      } else if (typeof name === \"symbol\") {\n        storageKey = undefined;\n      }\n\n      function persistLevelIfPossible(levelNum) {\n          var levelName = (logMethods[levelNum] || 'silent').toUpperCase();\n\n          if (typeof window === undefinedType || !storageKey) return;\n\n          // Use localStorage if available\n          try {\n              window.localStorage[storageKey] = levelName;\n              return;\n          } catch (ignore) {}\n\n          // Use session cookie as fallback\n          try {\n              window.document.cookie =\n                encodeURIComponent(storageKey) + \"=\" + levelName + \";\";\n          } catch (ignore) {}\n      }\n\n      function getPersistedLevel() {\n          var storedLevel;\n\n          if (typeof window === undefinedType || !storageKey) return;\n\n          try {\n              storedLevel = window.localStorage[storageKey];\n          } catch (ignore) {}\n\n          // Fallback to cookies if local storage gives us nothing\n          if (typeof storedLevel === undefinedType) {\n              try {\n                  var cookie = window.document.cookie;\n                  var location = cookie.indexOf(\n                      encodeURIComponent(storageKey) + \"=\");\n                  if (location !== -1) {\n                      storedLevel = /^([^;]+)/.exec(cookie.slice(location))[1];\n                  }\n              } catch (ignore) {}\n          }\n\n          // If the stored level is not valid, treat it as if nothing was stored.\n          if (self.levels[storedLevel] === undefined) {\n              storedLevel = undefined;\n          }\n\n          return storedLevel;\n      }\n\n      function clearPersistedLevel() {\n          if (typeof window === undefinedType || !storageKey) return;\n\n          // Use localStorage if available\n          try {\n              window.localStorage.removeItem(storageKey);\n              return;\n          } catch (ignore) {}\n\n          // Use session cookie as fallback\n          try {\n              window.document.cookie =\n                encodeURIComponent(storageKey) + \"=; expires=Thu, 01 Jan 1970 00:00:00 UTC\";\n          } catch (ignore) {}\n      }\n\n      /*\n       *\n       * Public logger API - see https://github.com/pimterry/loglevel for details\n       *\n       */\n\n      self.name = name;\n\n      self.levels = { \"TRACE\": 0, \"DEBUG\": 1, \"INFO\": 2, \"WARN\": 3,\n          \"ERROR\": 4, \"SILENT\": 5};\n\n      self.methodFactory = factory || defaultMethodFactory;\n\n      self.getLevel = function () {\n          return currentLevel;\n      };\n\n      self.setLevel = function (level, persist) {\n          if (typeof level === \"string\" && self.levels[level.toUpperCase()] !== undefined) {\n              level = self.levels[level.toUpperCase()];\n          }\n          if (typeof level === \"number\" && level >= 0 && level <= self.levels.SILENT) {\n              currentLevel = level;\n              if (persist !== false) {  // defaults to true\n                  persistLevelIfPossible(level);\n              }\n              replaceLoggingMethods.call(self, level, name);\n              if (typeof console === undefinedType && level < self.levels.SILENT) {\n                  return \"No console available for logging\";\n              }\n          } else {\n              throw \"log.setLevel() called with invalid level: \" + level;\n          }\n      };\n\n      self.setDefaultLevel = function (level) {\n          defaultLevel = level;\n          if (!getPersistedLevel()) {\n              self.setLevel(level, false);\n          }\n      };\n\n      self.resetLevel = function () {\n          self.setLevel(defaultLevel, false);\n          clearPersistedLevel();\n      };\n\n      self.enableAll = function(persist) {\n          self.setLevel(self.levels.TRACE, persist);\n      };\n\n      self.disableAll = function(persist) {\n          self.setLevel(self.levels.SILENT, persist);\n      };\n\n      // Initialize with the right level\n      var initialLevel = getPersistedLevel();\n      if (initialLevel == null) {\n          initialLevel = defaultLevel;\n      }\n      self.setLevel(initialLevel, false);\n    }\n\n    /*\n     *\n     * Top-level API\n     *\n     */\n\n    var defaultLogger = new Logger();\n\n    var _loggersByName = {};\n    defaultLogger.getLogger = function getLogger(name) {\n        if ((typeof name !== \"symbol\" && typeof name !== \"string\") || name === \"\") {\n          throw new TypeError(\"You must supply a name when creating a logger.\");\n        }\n\n        var logger = _loggersByName[name];\n        if (!logger) {\n          logger = _loggersByName[name] = new Logger(\n            name, defaultLogger.getLevel(), defaultLogger.methodFactory);\n        }\n        return logger;\n    };\n\n    // Grab the current global log variable in case of overwrite\n    var _log = (typeof window !== undefinedType) ? window.log : undefined;\n    defaultLogger.noConflict = function() {\n        if (typeof window !== undefinedType &&\n               window.log === defaultLogger) {\n            window.log = _log;\n        }\n\n        return defaultLogger;\n    };\n\n    defaultLogger.getLoggers = function getLoggers() {\n        return _loggersByName;\n    };\n\n    // ES6 default export, for compatibility\n    defaultLogger['default'] = defaultLogger;\n\n    return defaultLogger;\n}));\n","import * as log from 'loglevel';\r\n\r\nexport enum LogLevel {\r\n  trace = 0,\r\n  debug = 1,\r\n  info = 2,\r\n  warn = 3,\r\n  error = 4,\r\n  silent = 5,\r\n}\r\n\r\ntype LogLevelString = keyof typeof LogLevel;\r\n\r\ntype StructuredLogger = {\r\n  trace: (msg: string, context?: object) => void;\r\n  debug: (msg: string, context?: object) => void;\r\n  info: (msg: string, context?: object) => void;\r\n  warn: (msg: string, context?: object) => void;\r\n  error: (msg: string, context?: object) => void;\r\n  setDefaultLevel: (level: log.LogLevelDesc) => void;\r\n};\r\n\r\nconst livekitLogger = log.getLogger('livekit');\r\n\r\nlivekitLogger.setDefaultLevel(LogLevel.info);\r\n\r\nexport default livekitLogger as StructuredLogger;\r\n\r\nexport function setLogLevel(level: LogLevel | LogLevelString, loggerName?: 'livekit' | 'lk-e2ee') {\r\n  if (loggerName) {\r\n    log.getLogger(loggerName).setLevel(level);\r\n  }\r\n  for (const logger of Object.values(log.getLoggers())) {\r\n    logger.setLevel(level);\r\n  }\r\n}\r\n\r\nexport type LogExtension = (level: LogLevel, msg: string, context?: object) => void;\r\n\r\n/**\r\n * use this to hook into the logging function to allow sending internal livekit logs to third party services\r\n * if set, the browser logs will lose their stacktrace information (see https://github.com/pimterry/loglevel#writing-plugins)\r\n */\r\nexport function setLogExtension(extension: LogExtension) {\r\n  const originalFactory = livekitLogger.methodFactory;\r\n\r\n  livekitLogger.methodFactory = (methodName, configLevel, loggerName) => {\r\n    const rawMethod = originalFactory(methodName, configLevel, loggerName);\r\n\r\n    const logLevel = LogLevel[methodName as LogLevelString];\r\n    const needLog = logLevel >= configLevel && logLevel < LogLevel.silent;\r\n\r\n    return (msg, context?: [msg: string, context: object]) => {\r\n      if (context) rawMethod(msg, context);\r\n      else rawMethod(msg);\r\n      if (needLog) {\r\n        extension(logLevel, msg, context);\r\n      }\r\n    };\r\n  };\r\n  livekitLogger.setLevel(livekitLogger.getLevel()); // Be sure to call setLevel method in order to apply plugin\r\n}\r\n\r\nexport const workerLogger = log.getLogger('lk-e2ee') as StructuredLogger;\r\n","import type { KeyProviderOptions } from './types';\r\n\r\nexport const ENCRYPTION_ALGORITHM = 'AES-GCM';\r\n\r\n// We use a ringbuffer of keys so we can change them and still decode packets that were\r\n// encrypted with an old key. We use a size of 16 which corresponds to the four bits\r\n// in the frame trailer.\r\nexport const KEYRING_SIZE = 16;\r\n\r\n// How many consecutive frames can fail decrypting before a particular key gets marked as invalid\r\nexport const DECRYPTION_FAILURE_TOLERANCE = 10;\r\n\r\n// We copy the first bytes of the VP8 payload unencrypted.\r\n// For keyframes this is 10 bytes, for non-keyframes (delta) 3. See\r\n//   https://tools.ietf.org/html/rfc6386#section-9.1\r\n// This allows the bridge to continue detecting keyframes (only one byte needed in the JVB)\r\n// and is also a bit easier for the VP8 decoder (i.e. it generates funny garbage pictures\r\n// instead of being unable to decode).\r\n// This is a bit for show and we might want to reduce to 1 unconditionally in the final version.\r\n//\r\n// For audio (where frame.type is not set) we do not encrypt the opus TOC byte:\r\n//   https://tools.ietf.org/html/rfc6716#section-3.1\r\nexport const UNENCRYPTED_BYTES = {\r\n  key: 10,\r\n  delta: 3,\r\n  audio: 1, // frame.type is not set on audio, so this is set manually\r\n  empty: 0,\r\n} as const;\r\n\r\n/* We use a 12 byte bit IV. This is signalled in plain together with the\r\n packet. See https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/encrypt#parameters */\r\nexport const IV_LENGTH = 12;\r\n\r\n// flag set to indicate that e2ee has been setup for sender/receiver;\r\nexport const E2EE_FLAG = 'lk_e2ee';\r\n\r\nexport const SALT = 'LKFrameEncryptionKey';\r\n\r\nexport const KEY_PROVIDER_DEFAULTS: KeyProviderOptions = {\r\n  sharedKey: false,\r\n  ratchetSalt: SALT,\r\n  ratchetWindowSize: 8,\r\n  failureTolerance: DECRYPTION_FAILURE_TOLERANCE,\r\n} as const;\r\n\r\nexport const MAX_SIF_COUNT = 100;\r\nexport const MAX_SIF_DURATION = 2000;\r\n","export class LivekitError extends Error {\r\n  code: number;\r\n\r\n  constructor(code: number, message?: string) {\r\n    super(message || 'an error has occured');\r\n    this.code = code;\r\n  }\r\n}\r\n\r\nexport const enum ConnectionErrorReason {\r\n  NotAllowed,\r\n  ServerUnreachable,\r\n  InternalError,\r\n  Cancelled,\r\n}\r\n\r\nexport class ConnectionError extends LivekitError {\r\n  status?: number;\r\n\r\n  reason?: ConnectionErrorReason;\r\n\r\n  constructor(message?: string, reason?: ConnectionErrorReason, status?: number) {\r\n    super(1, message);\r\n    this.status = status;\r\n    this.reason = reason;\r\n  }\r\n}\r\n\r\nexport class DeviceUnsupportedError extends LivekitError {\r\n  constructor(message?: string) {\r\n    super(21, message ?? 'device is unsupported');\r\n  }\r\n}\r\n\r\nexport class TrackInvalidError extends LivekitError {\r\n  constructor(message?: string) {\r\n    super(20, message ?? 'track is invalid');\r\n  }\r\n}\r\n\r\nexport class UnsupportedServer extends LivekitError {\r\n  constructor(message?: string) {\r\n    super(10, message ?? 'unsupported server');\r\n  }\r\n}\r\n\r\nexport class UnexpectedConnectionState extends LivekitError {\r\n  constructor(message?: string) {\r\n    super(12, message ?? 'unexpected connection state');\r\n  }\r\n}\r\n\r\nexport class NegotiationError extends LivekitError {\r\n  constructor(message?: string) {\r\n    super(13, message ?? 'unable to negotiate');\r\n  }\r\n}\r\n\r\nexport class PublishDataError extends LivekitError {\r\n  constructor(message?: string) {\r\n    super(13, message ?? 'unable to publish data');\r\n  }\r\n}\r\n\r\nexport enum MediaDeviceFailure {\r\n  // user rejected permissions\r\n  PermissionDenied = 'PermissionDenied',\r\n  // device is not available\r\n  NotFound = 'NotFound',\r\n  // device is in use. On Windows, only a single tab may get access to a device at a time.\r\n  DeviceInUse = 'DeviceInUse',\r\n  Other = 'Other',\r\n}\r\n\r\nexport namespace MediaDeviceFailure {\r\n  export function getFailure(error: any): MediaDeviceFailure | undefined {\r\n    if (error && 'name' in error) {\r\n      if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {\r\n        return MediaDeviceFailure.NotFound;\r\n      }\r\n      if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {\r\n        return MediaDeviceFailure.PermissionDenied;\r\n      }\r\n      if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {\r\n        return MediaDeviceFailure.DeviceInUse;\r\n      }\r\n      return MediaDeviceFailure.Other;\r\n    }\r\n  }\r\n}\r\n","import { LivekitError } from '../room/errors';\r\n\r\nexport enum CryptorErrorReason {\r\n  InvalidKey = 0,\r\n  MissingKey = 1,\r\n  InternalError = 2,\r\n}\r\n\r\nexport class CryptorError extends LivekitError {\r\n  reason: CryptorErrorReason;\r\n\r\n  constructor(message?: string, reason: CryptorErrorReason = CryptorErrorReason.InternalError) {\r\n    super(40, message);\r\n    this.reason = reason;\r\n  }\r\n}\r\n","import type Participant from '../room/participant/Participant';\r\nimport type { CryptorError } from './errors';\r\nimport type { KeyInfo } from './types';\r\n\r\nexport enum KeyProviderEvent {\r\n  SetKey = 'setKey',\r\n  RatchetRequest = 'ratchetRequest',\r\n  KeyRatcheted = 'keyRatcheted',\r\n}\r\n\r\nexport type KeyProviderCallbacks = {\r\n  [KeyProviderEvent.SetKey]: (keyInfo: KeyInfo) => void;\r\n  [KeyProviderEvent.RatchetRequest]: (participantIdentity?: string, keyIndex?: number) => void;\r\n  [KeyProviderEvent.KeyRatcheted]: (material: CryptoKey, keyIndex?: number) => void;\r\n};\r\n\r\nexport enum KeyHandlerEvent {\r\n  KeyRatcheted = 'keyRatcheted',\r\n}\r\n\r\nexport type ParticipantKeyHandlerCallbacks = {\r\n  [KeyHandlerEvent.KeyRatcheted]: (\r\n    material: CryptoKey,\r\n    participantIdentity: string,\r\n    keyIndex?: number,\r\n  ) => void;\r\n};\r\n\r\nexport enum EncryptionEvent {\r\n  ParticipantEncryptionStatusChanged = 'participantEncryptionStatusChanged',\r\n  EncryptionError = 'encryptionError',\r\n}\r\n\r\nexport type E2EEManagerCallbacks = {\r\n  [EncryptionEvent.ParticipantEncryptionStatusChanged]: (\r\n    enabled: boolean,\r\n    participant: Participant,\r\n  ) => void;\r\n  [EncryptionEvent.EncryptionError]: (error: Error) => void;\r\n};\r\n\r\nexport type CryptorCallbacks = {\r\n  [CryptorEvent.Error]: (error: CryptorError) => void;\r\n};\r\n\r\nexport enum CryptorEvent {\r\n  Error = 'cryptorError',\r\n}\r\n","// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n'use strict';\n\nvar R = typeof Reflect === 'object' ? Reflect : null\nvar ReflectApply = R && typeof R.apply === 'function'\n  ? R.apply\n  : function ReflectApply(target, receiver, args) {\n    return Function.prototype.apply.call(target, receiver, args);\n  }\n\nvar ReflectOwnKeys\nif (R && typeof R.ownKeys === 'function') {\n  ReflectOwnKeys = R.ownKeys\n} else if (Object.getOwnPropertySymbols) {\n  ReflectOwnKeys = function ReflectOwnKeys(target) {\n    return Object.getOwnPropertyNames(target)\n      .concat(Object.getOwnPropertySymbols(target));\n  };\n} else {\n  ReflectOwnKeys = function ReflectOwnKeys(target) {\n    return Object.getOwnPropertyNames(target);\n  };\n}\n\nfunction ProcessEmitWarning(warning) {\n  if (console && console.warn) console.warn(warning);\n}\n\nvar NumberIsNaN = Number.isNaN || function NumberIsNaN(value) {\n  return value !== value;\n}\n\nfunction EventEmitter() {\n  EventEmitter.init.call(this);\n}\nmodule.exports = EventEmitter;\nmodule.exports.once = once;\n\n// Backwards-compat with node 0.10.x\nEventEmitter.EventEmitter = EventEmitter;\n\nEventEmitter.prototype._events = undefined;\nEventEmitter.prototype._eventsCount = 0;\nEventEmitter.prototype._maxListeners = undefined;\n\n// By default EventEmitters will print a warning if more than 10 listeners are\n// added to it. This is a useful default which helps finding memory leaks.\nvar defaultMaxListeners = 10;\n\nfunction checkListener(listener) {\n  if (typeof listener !== 'function') {\n    throw new TypeError('The \"listener\" argument must be of type Function. Received type ' + typeof listener);\n  }\n}\n\nObject.defineProperty(EventEmitter, 'defaultMaxListeners', {\n  enumerable: true,\n  get: function() {\n    return defaultMaxListeners;\n  },\n  set: function(arg) {\n    if (typeof arg !== 'number' || arg < 0 || NumberIsNaN(arg)) {\n      throw new RangeError('The value of \"defaultMaxListeners\" is out of range. It must be a non-negative number. Received ' + arg + '.');\n    }\n    defaultMaxListeners = arg;\n  }\n});\n\nEventEmitter.init = function() {\n\n  if (this._events === undefined ||\n      this._events === Object.getPrototypeOf(this)._events) {\n    this._events = Object.create(null);\n    this._eventsCount = 0;\n  }\n\n  this._maxListeners = this._maxListeners || undefined;\n};\n\n// Obviously not all Emitters should be limited to 10. This function allows\n// that to be increased. Set to zero for unlimited.\nEventEmitter.prototype.setMaxListeners = function setMaxListeners(n) {\n  if (typeof n !== 'number' || n < 0 || NumberIsNaN(n)) {\n    throw new RangeError('The value of \"n\" is out of range. It must be a non-negative number. Received ' + n + '.');\n  }\n  this._maxListeners = n;\n  return this;\n};\n\nfunction _getMaxListeners(that) {\n  if (that._maxListeners === undefined)\n    return EventEmitter.defaultMaxListeners;\n  return that._maxListeners;\n}\n\nEventEmitter.prototype.getMaxListeners = function getMaxListeners() {\n  return _getMaxListeners(this);\n};\n\nEventEmitter.prototype.emit = function emit(type) {\n  var args = [];\n  for (var i = 1; i < arguments.length; i++) args.push(arguments[i]);\n  var doError = (type === 'error');\n\n  var events = this._events;\n  if (events !== undefined)\n    doError = (doError && events.error === undefined);\n  else if (!doError)\n    return false;\n\n  // If there is no 'error' event listener then throw.\n  if (doError) {\n    var er;\n    if (args.length > 0)\n      er = args[0];\n    if (er instanceof Error) {\n      // Note: The comments on the `throw` lines are intentional, they show\n      // up in Node's output if this results in an unhandled exception.\n      throw er; // Unhandled 'error' event\n    }\n    // At least give some kind of context to the user\n    var err = new Error('Unhandled error.' + (er ? ' (' + er.message + ')' : ''));\n    err.context = er;\n    throw err; // Unhandled 'error' event\n  }\n\n  var handler = events[type];\n\n  if (handler === undefined)\n    return false;\n\n  if (typeof handler === 'function') {\n    ReflectApply(handler, this, args);\n  } else {\n    var len = handler.length;\n    var listeners = arrayClone(handler, len);\n    for (var i = 0; i < len; ++i)\n      ReflectApply(listeners[i], this, args);\n  }\n\n  return true;\n};\n\nfunction _addListener(target, type, listener, prepend) {\n  var m;\n  var events;\n  var existing;\n\n  checkListener(listener);\n\n  events = target._events;\n  if (events === undefined) {\n    events = target._events = Object.create(null);\n    target._eventsCount = 0;\n  } else {\n    // To avoid recursion in the case that type === \"newListener\"! Before\n    // adding it to the listeners, first emit \"newListener\".\n    if (events.newListener !== undefined) {\n      target.emit('newListener', type,\n                  listener.listener ? listener.listener : listener);\n\n      // Re-assign `events` because a newListener handler could have caused the\n      // this._events to be assigned to a new object\n      events = target._events;\n    }\n    existing = events[type];\n  }\n\n  if (existing === undefined) {\n    // Optimize the case of one listener. Don't need the extra array object.\n    existing = events[type] = listener;\n    ++target._eventsCount;\n  } else {\n    if (typeof existing === 'function') {\n      // Adding the second element, need to change to array.\n      existing = events[type] =\n        prepend ? [listener, existing] : [existing, listener];\n      // If we've already got an array, just append.\n    } else if (prepend) {\n      existing.unshift(listener);\n    } else {\n      existing.push(listener);\n    }\n\n    // Check for listener leak\n    m = _getMaxListeners(target);\n    if (m > 0 && existing.length > m && !existing.warned) {\n      existing.warned = true;\n      // No error code for this since it is a Warning\n      // eslint-disable-next-line no-restricted-syntax\n      var w = new Error('Possible EventEmitter memory leak detected. ' +\n                          existing.length + ' ' + String(type) + ' listeners ' +\n                          'added. Use emitter.setMaxListeners() to ' +\n                          'increase limit');\n      w.name = 'MaxListenersExceededWarning';\n      w.emitter = target;\n      w.type = type;\n      w.count = existing.length;\n      ProcessEmitWarning(w);\n    }\n  }\n\n  return target;\n}\n\nEventEmitter.prototype.addListener = function addListener(type, listener) {\n  return _addListener(this, type, listener, false);\n};\n\nEventEmitter.prototype.on = EventEmitter.prototype.addListener;\n\nEventEmitter.prototype.prependListener =\n    function prependListener(type, listener) {\n      return _addListener(this, type, listener, true);\n    };\n\nfunction onceWrapper() {\n  if (!this.fired) {\n    this.target.removeListener(this.type, this.wrapFn);\n    this.fired = true;\n    if (arguments.length === 0)\n      return this.listener.call(this.target);\n    return this.listener.apply(this.target, arguments);\n  }\n}\n\nfunction _onceWrap(target, type, listener) {\n  var state = { fired: false, wrapFn: undefined, target: target, type: type, listener: listener };\n  var wrapped = onceWrapper.bind(state);\n  wrapped.listener = listener;\n  state.wrapFn = wrapped;\n  return wrapped;\n}\n\nEventEmitter.prototype.once = function once(type, listener) {\n  checkListener(listener);\n  this.on(type, _onceWrap(this, type, listener));\n  return this;\n};\n\nEventEmitter.prototype.prependOnceListener =\n    function prependOnceListener(type, listener) {\n      checkListener(listener);\n      this.prependListener(type, _onceWrap(this, type, listener));\n      return this;\n    };\n\n// Emits a 'removeListener' event if and only if the listener was removed.\nEventEmitter.prototype.removeListener =\n    function removeListener(type, listener) {\n      var list, events, position, i, originalListener;\n\n      checkListener(listener);\n\n      events = this._events;\n      if (events === undefined)\n        return this;\n\n      list = events[type];\n      if (list === undefined)\n        return this;\n\n      if (list === listener || list.listener === listener) {\n        if (--this._eventsCount === 0)\n          this._events = Object.create(null);\n        else {\n          delete events[type];\n          if (events.removeListener)\n            this.emit('removeListener', type, list.listener || listener);\n        }\n      } else if (typeof list !== 'function') {\n        position = -1;\n\n        for (i = list.length - 1; i >= 0; i--) {\n          if (list[i] === listener || list[i].listener === listener) {\n            originalListener = list[i].listener;\n            position = i;\n            break;\n          }\n        }\n\n        if (position < 0)\n          return this;\n\n        if (position === 0)\n          list.shift();\n        else {\n          spliceOne(list, position);\n        }\n\n        if (list.length === 1)\n          events[type] = list[0];\n\n        if (events.removeListener !== undefined)\n          this.emit('removeListener', type, originalListener || listener);\n      }\n\n      return this;\n    };\n\nEventEmitter.prototype.off = EventEmitter.prototype.removeListener;\n\nEventEmitter.prototype.removeAllListeners =\n    function removeAllListeners(type) {\n      var listeners, events, i;\n\n      events = this._events;\n      if (events === undefined)\n        return this;\n\n      // not listening for removeListener, no need to emit\n      if (events.removeListener === undefined) {\n        if (arguments.length === 0) {\n          this._events = Object.create(null);\n          this._eventsCount = 0;\n        } else if (events[type] !== undefined) {\n          if (--this._eventsCount === 0)\n            this._events = Object.create(null);\n          else\n            delete events[type];\n        }\n        return this;\n      }\n\n      // emit removeListener for all listeners on all events\n      if (arguments.length === 0) {\n        var keys = Object.keys(events);\n        var key;\n        for (i = 0; i < keys.length; ++i) {\n          key = keys[i];\n          if (key === 'removeListener') continue;\n          this.removeAllListeners(key);\n        }\n        this.removeAllListeners('removeListener');\n        this._events = Object.create(null);\n        this._eventsCount = 0;\n        return this;\n      }\n\n      listeners = events[type];\n\n      if (typeof listeners === 'function') {\n        this.removeListener(type, listeners);\n      } else if (listeners !== undefined) {\n        // LIFO order\n        for (i = listeners.length - 1; i >= 0; i--) {\n          this.removeListener(type, listeners[i]);\n        }\n      }\n\n      return this;\n    };\n\nfunction _listeners(target, type, unwrap) {\n  var events = target._events;\n\n  if (events === undefined)\n    return [];\n\n  var evlistener = events[type];\n  if (evlistener === undefined)\n    return [];\n\n  if (typeof evlistener === 'function')\n    return unwrap ? [evlistener.listener || evlistener] : [evlistener];\n\n  return unwrap ?\n    unwrapListeners(evlistener) : arrayClone(evlistener, evlistener.length);\n}\n\nEventEmitter.prototype.listeners = function listeners(type) {\n  return _listeners(this, type, true);\n};\n\nEventEmitter.prototype.rawListeners = function rawListeners(type) {\n  return _listeners(this, type, false);\n};\n\nEventEmitter.listenerCount = function(emitter, type) {\n  if (typeof emitter.listenerCount === 'function') {\n    return emitter.listenerCount(type);\n  } else {\n    return listenerCount.call(emitter, type);\n  }\n};\n\nEventEmitter.prototype.listenerCount = listenerCount;\nfunction listenerCount(type) {\n  var events = this._events;\n\n  if (events !== undefined) {\n    var evlistener = events[type];\n\n    if (typeof evlistener === 'function') {\n      return 1;\n    } else if (evlistener !== undefined) {\n      return evlistener.length;\n    }\n  }\n\n  return 0;\n}\n\nEventEmitter.prototype.eventNames = function eventNames() {\n  return this._eventsCount > 0 ? ReflectOwnKeys(this._events) : [];\n};\n\nfunction arrayClone(arr, n) {\n  var copy = new Array(n);\n  for (var i = 0; i < n; ++i)\n    copy[i] = arr[i];\n  return copy;\n}\n\nfunction spliceOne(list, index) {\n  for (; index + 1 < list.length; index++)\n    list[index] = list[index + 1];\n  list.pop();\n}\n\nfunction unwrapListeners(arr) {\n  var ret = new Array(arr.length);\n  for (var i = 0; i < ret.length; ++i) {\n    ret[i] = arr[i].listener || arr[i];\n  }\n  return ret;\n}\n\nfunction once(emitter, name) {\n  return new Promise(function (resolve, reject) {\n    function errorListener(err) {\n      emitter.removeListener(name, resolver);\n      reject(err);\n    }\n\n    function resolver() {\n      if (typeof emitter.removeListener === 'function') {\n        emitter.removeListener('error', errorListener);\n      }\n      resolve([].slice.call(arguments));\n    };\n\n    eventTargetAgnosticAddListener(emitter, name, resolver, { once: true });\n    if (name !== 'error') {\n      addErrorHandlerIfEventEmitter(emitter, errorListener, { once: true });\n    }\n  });\n}\n\nfunction addErrorHandlerIfEventEmitter(emitter, handler, flags) {\n  if (typeof emitter.on === 'function') {\n    eventTargetAgnosticAddListener(emitter, 'error', handler, flags);\n  }\n}\n\nfunction eventTargetAgnosticAddListener(emitter, name, listener, flags) {\n  if (typeof emitter.on === 'function') {\n    if (flags.once) {\n      emitter.once(name, listener);\n    } else {\n      emitter.on(name, listener);\n    }\n  } else if (typeof emitter.addEventListener === 'function') {\n    // EventTarget does not have `error` event semantics like Node\n    // EventEmitters, we do not listen for `error` events here.\n    emitter.addEventListener(name, function wrapListener(arg) {\n      // IE does not have builtin `{ once: true }` support so we\n      // have to do it manually.\n      if (flags.once) {\n        emitter.removeEventListener(name, wrapListener);\n      }\n      listener(arg);\n    });\n  } else {\n    throw new TypeError('The \"emitter\" argument must be of type EventEmitter. Received type ' + typeof emitter);\n  }\n}\n","import type { Track } from './Track';\r\n\r\nexport interface TrackPublishDefaults {\r\n  /**\r\n   * encoding parameters for camera track\r\n   */\r\n  videoEncoding?: VideoEncoding;\r\n\r\n  /**\r\n   * @experimental\r\n   */\r\n  backupCodec?: { codec: BackupVideoCodec; encoding: VideoEncoding } | false;\r\n\r\n  /**\r\n   * encoding parameters for screen share track\r\n   */\r\n  screenShareEncoding?: VideoEncoding;\r\n\r\n  /**\r\n   * codec, defaults to vp8; for svc codecs, auto enable vp8\r\n   * as backup. (TBD)\r\n   */\r\n  videoCodec?: VideoCodec;\r\n\r\n  /**\r\n   * max audio bitrate, defaults to [[AudioPresets.music]]\r\n   * @deprecated use `audioPreset` instead\r\n   */\r\n  audioBitrate?: number;\r\n\r\n  /**\r\n   * which audio preset should be used for publishing (audio) tracks\r\n   * defaults to [[AudioPresets.music]]\r\n   */\r\n  audioPreset?: AudioPreset;\r\n\r\n  /**\r\n   * dtx (Discontinuous Transmission of audio), enabled by default for mono tracks.\r\n   */\r\n  dtx?: boolean;\r\n\r\n  /**\r\n   * red (Redundant Audio Data), enabled by default for mono tracks.\r\n   */\r\n  red?: boolean;\r\n\r\n  /**\r\n   * publish track in stereo mode (or set to false to disable). defaults determined by capture channel count.\r\n   */\r\n  forceStereo?: boolean;\r\n\r\n  /**\r\n   * use simulcast, defaults to true.\r\n   * When using simulcast, LiveKit will publish up to three versions of the stream\r\n   * at various resolutions.\r\n   */\r\n  simulcast?: boolean;\r\n\r\n  /**\r\n   * scalability mode for svc codecs, defaults to 'L3T3'.\r\n   * for svc codecs, simulcast is disabled.\r\n   */\r\n  scalabilityMode?: ScalabilityMode;\r\n\r\n  /**\r\n   * Up to two additional simulcast layers to publish in addition to the original\r\n   * Track.\r\n   * When left blank, it defaults to h180, h360.\r\n   * If a SVC codec is used (VP9 or AV1), this field has no effect.\r\n   *\r\n   * To publish three total layers, you would specify:\r\n   * {\r\n   *   videoEncoding: {...}, // encoding of the primary layer\r\n   *   videoSimulcastLayers: [\r\n   *     VideoPresets.h540,\r\n   *     VideoPresets.h216,\r\n   *   ],\r\n   * }\r\n   */\r\n  videoSimulcastLayers?: Array<VideoPreset>;\r\n\r\n  /**\r\n   * custom video simulcast layers for screen tracks\r\n   * Note: the layers need to be ordered from lowest to highest quality\r\n   */\r\n  screenShareSimulcastLayers?: Array<VideoPreset>;\r\n\r\n  /**\r\n   * For local tracks, stop the underlying MediaStreamTrack when the track is muted (or paused)\r\n   * on some platforms, this option is necessary to disable the microphone recording indicator.\r\n   * Note: when this is enabled, and BT devices are connected, they will transition between\r\n   * profiles (e.g. HFP to A2DP) and there will be an audible difference in playback.\r\n   *\r\n   * defaults to false\r\n   */\r\n  stopMicTrackOnMute?: boolean;\r\n}\r\n\r\n/**\r\n * Options when publishing tracks\r\n */\r\nexport interface TrackPublishOptions extends TrackPublishDefaults {\r\n  /**\r\n   * set a track name\r\n   */\r\n  name?: string;\r\n\r\n  /**\r\n   * Source of track, camera, microphone, or screen\r\n   */\r\n  source?: Track.Source;\r\n}\r\n\r\nexport interface CreateLocalTracksOptions {\r\n  /**\r\n   * audio track options, true to create with defaults. false if audio shouldn't be created\r\n   * default true\r\n   */\r\n  audio?: boolean | AudioCaptureOptions;\r\n\r\n  /**\r\n   * video track options, true to create with defaults. false if video shouldn't be created\r\n   * default true\r\n   */\r\n  video?: boolean | VideoCaptureOptions;\r\n}\r\n\r\nexport interface VideoCaptureOptions {\r\n  /**\r\n   * A ConstrainDOMString object specifying a device ID or an array of device\r\n   * IDs which are acceptable and/or required.\r\n   */\r\n  deviceId?: ConstrainDOMString;\r\n\r\n  /**\r\n   * a facing or an array of facings which are acceptable and/or required.\r\n   */\r\n  facingMode?: 'user' | 'environment' | 'left' | 'right';\r\n\r\n  resolution?: VideoResolution;\r\n}\r\n\r\nexport interface ScreenShareCaptureOptions {\r\n  /**\r\n   * true to capture audio shared. browser support for audio capturing in\r\n   * screenshare is limited: https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getDisplayMedia#browser_compatibility\r\n   */\r\n  audio?: boolean | AudioCaptureOptions;\r\n\r\n  /**\r\n   * only allows for 'true' and chrome allows for additional options to be passed in\r\n   * https://developer.chrome.com/docs/web-platform/screen-sharing-controls/#displaySurface\r\n   */\r\n  video?: true | { displaySurface?: 'window' | 'browser' | 'monitor' };\r\n\r\n  /** capture resolution, defaults to full HD */\r\n  resolution?: VideoResolution;\r\n\r\n  /** a CaptureController object instance containing methods that can be used to further manipulate the capture session if included. */\r\n  controller?: unknown; // TODO replace type with CaptureController once it lands in TypeScript\r\n\r\n  /** specifies whether the browser should allow the user to select the current tab for capture */\r\n  selfBrowserSurface?: 'include' | 'exclude';\r\n\r\n  /** specifies whether the browser should display a control to allow the user to dynamically switch the shared tab during screen-sharing. */\r\n  surfaceSwitching?: 'include' | 'exclude';\r\n\r\n  /** specifies whether the browser should include the system audio among the possible audio sources offered to the user */\r\n  systemAudio?: 'include' | 'exclude';\r\n\r\n  /**\r\n   * Experimental option to control whether the audio playing in a tab will continue to be played out of a user's\r\n   * local speakers when the tab is captured.\r\n   */\r\n  suppressLocalAudioPlayback?: boolean;\r\n}\r\n\r\nexport interface AudioCaptureOptions {\r\n  /**\r\n   * specifies whether automatic gain control is preferred and/or required\r\n   */\r\n  autoGainControl?: ConstrainBoolean;\r\n\r\n  /**\r\n   * the channel count or range of channel counts which are acceptable and/or required\r\n   */\r\n  channelCount?: ConstrainULong;\r\n\r\n  /**\r\n   * A ConstrainDOMString object specifying a device ID or an array of device\r\n   * IDs which are acceptable and/or required.\r\n   */\r\n  deviceId?: ConstrainDOMString;\r\n\r\n  /**\r\n   * whether or not echo cancellation is preferred and/or required\r\n   */\r\n  echoCancellation?: ConstrainBoolean;\r\n\r\n  /**\r\n   * the latency or range of latencies which are acceptable and/or required.\r\n   */\r\n  latency?: ConstrainDouble;\r\n\r\n  /**\r\n   * whether noise suppression is preferred and/or required.\r\n   */\r\n  noiseSuppression?: ConstrainBoolean;\r\n\r\n  /**\r\n   * the sample rate or range of sample rates which are acceptable and/or required.\r\n   */\r\n  sampleRate?: ConstrainULong;\r\n\r\n  /**\r\n   * sample size or range of sample sizes which are acceptable and/or required.\r\n   */\r\n  sampleSize?: ConstrainULong;\r\n}\r\n\r\nexport interface AudioOutputOptions {\r\n  /**\r\n   * deviceId to output audio\r\n   *\r\n   * Only supported on browsers where `setSinkId` is available\r\n   */\r\n  deviceId?: string;\r\n}\r\n\r\nexport interface VideoResolution {\r\n  width: number;\r\n  height: number;\r\n  frameRate?: number;\r\n  aspectRatio?: number;\r\n}\r\n\r\nexport interface VideoEncoding {\r\n  maxBitrate: number;\r\n  maxFramerate?: number;\r\n  priority?: RTCPriorityType;\r\n}\r\n\r\nexport class VideoPreset {\r\n  encoding: VideoEncoding;\r\n\r\n  width: number;\r\n\r\n  height: number;\r\n\r\n  constructor(\r\n    width: number,\r\n    height: number,\r\n    maxBitrate: number,\r\n    maxFramerate?: number,\r\n    priority?: RTCPriorityType,\r\n  ) {\r\n    this.width = width;\r\n    this.height = height;\r\n    this.encoding = {\r\n      maxBitrate,\r\n      maxFramerate,\r\n      priority,\r\n    };\r\n  }\r\n\r\n  get resolution(): VideoResolution {\r\n    return {\r\n      width: this.width,\r\n      height: this.height,\r\n      frameRate: this.encoding.maxFramerate,\r\n      aspectRatio: this.width / this.height,\r\n    };\r\n  }\r\n}\r\n\r\nexport interface AudioPreset {\r\n  maxBitrate: number;\r\n  priority?: RTCPriorityType;\r\n}\r\n\r\nconst backupCodecs = ['vp8', 'h264'] as const;\r\n\r\nexport const videoCodecs = ['vp8', 'h264', 'vp9', 'av1'] as const;\r\n\r\nexport type VideoCodec = (typeof videoCodecs)[number];\r\n\r\nexport type BackupVideoCodec = (typeof backupCodecs)[number];\r\n\r\nexport function isBackupCodec(codec: string): codec is BackupVideoCodec {\r\n  return !!backupCodecs.find((backup) => backup === codec);\r\n}\r\n\r\nexport function isCodecEqual(c1: string | undefined, c2: string | undefined): boolean {\r\n  return (\r\n    c1?.toLowerCase().replace(/audio\\/|video\\//y, '') ===\r\n    c2?.toLowerCase().replace(/audio\\/|video\\//y, '')\r\n  );\r\n}\r\n\r\n/**\r\n * scalability modes for svc.\r\n */\r\nexport type ScalabilityMode = 'L1T3' | 'L2T3' | 'L2T3_KEY' | 'L3T3' | 'L3T3_KEY';\r\n\r\nexport namespace AudioPresets {\r\n  export const telephone: AudioPreset = {\r\n    maxBitrate: 12_000,\r\n  };\r\n  export const speech: AudioPreset = {\r\n    maxBitrate: 20_000,\r\n  };\r\n  export const music: AudioPreset = {\r\n    maxBitrate: 32_000,\r\n  };\r\n  export const musicStereo: AudioPreset = {\r\n    maxBitrate: 48_000,\r\n  };\r\n  export const musicHighQuality: AudioPreset = {\r\n    maxBitrate: 64_000,\r\n  };\r\n  export const musicHighQualityStereo: AudioPreset = {\r\n    maxBitrate: 96_000,\r\n  };\r\n}\r\n\r\n/**\r\n * Sane presets for video resolution/encoding\r\n */\r\nexport const VideoPresets = {\r\n  h90: new VideoPreset(160, 90, 90_000, 20),\r\n  h180: new VideoPreset(320, 180, 160_000, 20),\r\n  h216: new VideoPreset(384, 216, 180_000, 20),\r\n  h360: new VideoPreset(640, 360, 450_000, 20),\r\n  h540: new VideoPreset(960, 540, 800_000, 25),\r\n  h720: new VideoPreset(1280, 720, 1_700_000, 30),\r\n  h1080: new VideoPreset(1920, 1080, 3_000_000, 30),\r\n  h1440: new VideoPreset(2560, 1440, 5_000_000, 30),\r\n  h2160: new VideoPreset(3840, 2160, 8_000_000, 30),\r\n} as const;\r\n\r\n/**\r\n * Four by three presets\r\n */\r\nexport const VideoPresets43 = {\r\n  h120: new VideoPreset(160, 120, 70_000, 20),\r\n  h180: new VideoPreset(240, 180, 125_000, 20),\r\n  h240: new VideoPreset(320, 240, 140_000, 20),\r\n  h360: new VideoPreset(480, 360, 330_000, 20),\r\n  h480: new VideoPreset(640, 480, 500_000, 20),\r\n  h540: new VideoPreset(720, 540, 600_000, 25),\r\n  h720: new VideoPreset(960, 720, 1_300_000, 30),\r\n  h1080: new VideoPreset(1440, 1080, 2_300_000, 30),\r\n  h1440: new VideoPreset(1920, 1440, 3_800_000, 30),\r\n} as const;\r\n\r\nexport const ScreenSharePresets = {\r\n  h360fps3: new VideoPreset(640, 360, 200_000, 3, 'medium'),\r\n  h720fps5: new VideoPreset(1280, 720, 400_000, 5, 'medium'),\r\n  h720fps15: new VideoPreset(1280, 720, 1_500_000, 15, 'medium'),\r\n  h720fps30: new VideoPreset(1280, 720, 2_000_000, 30, 'medium'),\r\n  h1080fps15: new VideoPreset(1920, 1080, 2_500_000, 15, 'medium'),\r\n  h1080fps30: new VideoPreset(1920, 1080, 4_000_000, 30, 'medium'),\r\n} as const;\r\n","import { videoCodecs } from '../room/track/options';\r\nimport type { VideoCodec } from '../room/track/options';\r\nimport { ENCRYPTION_ALGORITHM } from './constants';\r\n\r\nexport function isE2EESupported() {\r\n  return isInsertableStreamSupported() || isScriptTransformSupported();\r\n}\r\n\r\nexport function isScriptTransformSupported() {\r\n  // @ts-ignore\r\n  return typeof window.RTCRtpScriptTransform !== 'undefined';\r\n}\r\n\r\nexport function isInsertableStreamSupported() {\r\n  return (\r\n    typeof window.RTCRtpSender !== 'undefined' &&\r\n    // @ts-ignore\r\n    typeof window.RTCRtpSender.prototype.createEncodedStreams !== 'undefined'\r\n  );\r\n}\r\n\r\nexport function isVideoFrame(\r\n  frame: RTCEncodedAudioFrame | RTCEncodedVideoFrame,\r\n): frame is RTCEncodedVideoFrame {\r\n  return 'type' in frame;\r\n}\r\n\r\nexport async function importKey(\r\n  keyBytes: Uint8Array | ArrayBuffer,\r\n  algorithm: string | { name: string } = { name: ENCRYPTION_ALGORITHM },\r\n  usage: 'derive' | 'encrypt' = 'encrypt',\r\n) {\r\n  // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/importKey\r\n  return crypto.subtle.importKey(\r\n    'raw',\r\n    keyBytes,\r\n    algorithm,\r\n    false,\r\n    usage === 'derive' ? ['deriveBits', 'deriveKey'] : ['encrypt', 'decrypt'],\r\n  );\r\n}\r\n\r\nexport async function createKeyMaterialFromString(password: string) {\r\n  let enc = new TextEncoder();\r\n\r\n  const keyMaterial = await crypto.subtle.importKey(\r\n    'raw',\r\n    enc.encode(password),\r\n    {\r\n      name: 'PBKDF2',\r\n    },\r\n    false,\r\n    ['deriveBits', 'deriveKey'],\r\n  );\r\n\r\n  return keyMaterial;\r\n}\r\n\r\nexport async function createKeyMaterialFromBuffer(cryptoBuffer: ArrayBuffer) {\r\n  const keyMaterial = await crypto.subtle.importKey('raw', cryptoBuffer, 'HKDF', false, [\r\n    'deriveBits',\r\n    'deriveKey',\r\n  ]);\r\n\r\n  return keyMaterial;\r\n}\r\n\r\nfunction getAlgoOptions(algorithmName: string, salt: string) {\r\n  const textEncoder = new TextEncoder();\r\n  const encodedSalt = textEncoder.encode(salt);\r\n  switch (algorithmName) {\r\n    case 'HKDF':\r\n      return {\r\n        name: 'HKDF',\r\n        salt: encodedSalt,\r\n        hash: 'SHA-256',\r\n        info: new ArrayBuffer(128),\r\n      };\r\n    case 'PBKDF2': {\r\n      return {\r\n        name: 'PBKDF2',\r\n        salt: encodedSalt,\r\n        hash: 'SHA-256',\r\n        iterations: 100000,\r\n      };\r\n    }\r\n    default:\r\n      throw new Error(`algorithm ${algorithmName} is currently unsupported`);\r\n  }\r\n}\r\n\r\n/**\r\n * Derives a set of keys from the master key.\r\n * See https://tools.ietf.org/html/draft-omara-sframe-00#section-4.3.1\r\n */\r\nexport async function deriveKeys(material: CryptoKey, salt: string) {\r\n  const algorithmOptions = getAlgoOptions(material.algorithm.name, salt);\r\n\r\n  // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/deriveKey#HKDF\r\n  // https://developer.mozilla.org/en-US/docs/Web/API/HkdfParams\r\n  const encryptionKey = await crypto.subtle.deriveKey(\r\n    algorithmOptions,\r\n    material,\r\n    {\r\n      name: ENCRYPTION_ALGORITHM,\r\n      length: 128,\r\n    },\r\n    false,\r\n    ['encrypt', 'decrypt'],\r\n  );\r\n\r\n  return { material, encryptionKey };\r\n}\r\n\r\nexport function createE2EEKey(): Uint8Array {\r\n  return window.crypto.getRandomValues(new Uint8Array(32));\r\n}\r\n\r\nexport function mimeTypeToVideoCodecString(mimeType: string) {\r\n  const codec = mimeType.split('/')[1].toLowerCase() as VideoCodec;\r\n  if (!videoCodecs.includes(codec)) {\r\n    throw Error(`Video codec not supported: ${codec}`);\r\n  }\r\n  return codec;\r\n}\r\n\r\n/**\r\n * Ratchets a key. See\r\n * https://tools.ietf.org/html/draft-omara-sframe-00#section-4.3.5.1\r\n */\r\nexport async function ratchet(material: CryptoKey, salt: string): Promise<ArrayBuffer> {\r\n  const algorithmOptions = getAlgoOptions(material.algorithm.name, salt);\r\n\r\n  // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/deriveBits\r\n  return crypto.subtle.deriveBits(algorithmOptions, material, 256);\r\n}\r\n\r\nexport function needsRbspUnescaping(frameData: Uint8Array) {\r\n  for (var i = 0; i < frameData.length - 3; i++) {\r\n    if (frameData[i] == 0 && frameData[i + 1] == 0 && frameData[i + 2] == 3) return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function parseRbsp(stream: Uint8Array): Uint8Array {\r\n  const dataOut: number[] = [];\r\n  var length = stream.length;\r\n  for (var i = 0; i < stream.length; ) {\r\n    // Be careful about over/underflow here. byte_length_ - 3 can underflow, and\r\n    // i + 3 can overflow, but byte_length_ - i can't, because i < byte_length_\r\n    // above, and that expression will produce the number of bytes left in\r\n    // the stream including the byte at i.\r\n    if (length - i >= 3 && !stream[i] && !stream[i + 1] && stream[i + 2] == 3) {\r\n      // Two rbsp bytes.\r\n      dataOut.push(stream[i++]);\r\n      dataOut.push(stream[i++]);\r\n      // Skip the emulation byte.\r\n      i++;\r\n    } else {\r\n      // Single rbsp byte.\r\n      dataOut.push(stream[i++]);\r\n    }\r\n  }\r\n  return new Uint8Array(dataOut);\r\n}\r\n\r\nconst kZerosInStartSequence = 2;\r\nconst kEmulationByte = 3;\r\n\r\nexport function writeRbsp(data_in: Uint8Array): Uint8Array {\r\n  const dataOut: number[] = [];\r\n  var numConsecutiveZeros = 0;\r\n  for (var i = 0; i < data_in.length; ++i) {\r\n    var byte = data_in[i];\r\n    if (byte <= kEmulationByte && numConsecutiveZeros >= kZerosInStartSequence) {\r\n      // Need to escape.\r\n      dataOut.push(kEmulationByte);\r\n      numConsecutiveZeros = 0;\r\n    }\r\n    dataOut.push(byte);\r\n    if (byte == 0) {\r\n      ++numConsecutiveZeros;\r\n    } else {\r\n      numConsecutiveZeros = 0;\r\n    }\r\n  }\r\n  return new Uint8Array(dataOut);\r\n}\r\n","import { MAX_SIF_COUNT, MAX_SIF_DURATION } from '../constants';\r\n\r\nexport class SifGuard {\r\n  private consecutiveSifCount = 0;\r\n\r\n  private sifSequenceStartedAt: number | undefined;\r\n\r\n  private lastSifReceivedAt: number = 0;\r\n\r\n  private userFramesSinceSif: number = 0;\r\n\r\n  recordSif() {\r\n    this.consecutiveSifCount += 1;\r\n    this.sifSequenceStartedAt ??= Date.now();\r\n    this.lastSifReceivedAt = Date.now();\r\n  }\r\n\r\n  recordUserFrame() {\r\n    if (this.sifSequenceStartedAt === undefined) {\r\n      return;\r\n    } else {\r\n      this.userFramesSinceSif += 1;\r\n    }\r\n    if (\r\n      // reset if we received more user frames than SIFs\r\n      this.userFramesSinceSif > this.consecutiveSifCount ||\r\n      // also reset if we got a new user frame and the latest SIF frame hasn't been updated in a while\r\n      Date.now() - this.lastSifReceivedAt > MAX_SIF_DURATION\r\n    ) {\r\n      this.reset();\r\n    }\r\n  }\r\n\r\n  isSifAllowed() {\r\n    return (\r\n      this.consecutiveSifCount < MAX_SIF_COUNT &&\r\n      (this.sifSequenceStartedAt === undefined ||\r\n        Date.now() - this.sifSequenceStartedAt < MAX_SIF_DURATION)\r\n    );\r\n  }\r\n\r\n  reset() {\r\n    this.userFramesSinceSif = 0;\r\n    this.consecutiveSifCount = 0;\r\n    this.sifSequenceStartedAt = undefined;\r\n  }\r\n}\r\n","/* eslint-disable @typescript-eslint/no-unused-vars */\r\n// TODO code inspired by https://github.com/webrtc/samples/blob/gh-pages/src/content/insertable-streams/endtoend-encryption/js/worker.js\r\nimport { EventEmitter } from 'events';\r\nimport type TypedEventEmitter from 'typed-emitter';\r\nimport { workerLogger } from '../../logger';\r\nimport type { VideoCodec } from '../../room/track/options';\r\nimport { ENCRYPTION_ALGORITHM, IV_LENGTH, UNENCRYPTED_BYTES } from '../constants';\r\nimport { CryptorError, CryptorErrorReason } from '../errors';\r\nimport { CryptorCallbacks, CryptorEvent } from '../events';\r\nimport type { DecodeRatchetOptions, KeyProviderOptions, KeySet } from '../types';\r\nimport { deriveKeys, isVideoFrame, needsRbspUnescaping, parseRbsp, writeRbsp } from '../utils';\r\nimport type { ParticipantKeyHandler } from './ParticipantKeyHandler';\r\nimport { SifGuard } from './SifGuard';\r\n\r\nexport const encryptionEnabledMap: Map<string, boolean> = new Map();\r\n\r\nexport interface FrameCryptorConstructor {\r\n  new (opts?: unknown): BaseFrameCryptor;\r\n}\r\n\r\nexport interface TransformerInfo {\r\n  readable: ReadableStream;\r\n  writable: WritableStream;\r\n  transformer: TransformStream;\r\n  abortController: AbortController;\r\n}\r\n\r\nexport class BaseFrameCryptor extends (EventEmitter as new () => TypedEventEmitter<CryptorCallbacks>) {\r\n  protected encodeFunction(\r\n    encodedFrame: RTCEncodedVideoFrame | RTCEncodedAudioFrame,\r\n    controller: TransformStreamDefaultController,\r\n  ): Promise<any> {\r\n    throw Error('not implemented for subclass');\r\n  }\r\n\r\n  protected decodeFunction(\r\n    encodedFrame: RTCEncodedVideoFrame | RTCEncodedAudioFrame,\r\n    controller: TransformStreamDefaultController,\r\n  ): Promise<any> {\r\n    throw Error('not implemented for subclass');\r\n  }\r\n}\r\n\r\n/**\r\n * Cryptor is responsible for en-/decrypting media frames.\r\n * Each Cryptor instance is responsible for en-/decrypting a single mediaStreamTrack.\r\n */\r\nexport class FrameCryptor extends BaseFrameCryptor {\r\n  private sendCounts: Map<number, number>;\r\n\r\n  private participantIdentity: string | undefined;\r\n\r\n  private trackId: string | undefined;\r\n\r\n  private keys: ParticipantKeyHandler;\r\n\r\n  private videoCodec?: VideoCodec;\r\n\r\n  private rtpMap: Map<number, VideoCodec>;\r\n\r\n  private keyProviderOptions: KeyProviderOptions;\r\n\r\n  /**\r\n   * used for detecting server injected unencrypted frames\r\n   */\r\n  private sifTrailer: Uint8Array;\r\n\r\n  private sifGuard: SifGuard;\r\n\r\n  constructor(opts: {\r\n    keys: ParticipantKeyHandler;\r\n    participantIdentity: string;\r\n    keyProviderOptions: KeyProviderOptions;\r\n    sifTrailer?: Uint8Array;\r\n  }) {\r\n    super();\r\n    this.sendCounts = new Map();\r\n    this.keys = opts.keys;\r\n    this.participantIdentity = opts.participantIdentity;\r\n    this.rtpMap = new Map();\r\n    this.keyProviderOptions = opts.keyProviderOptions;\r\n    this.sifTrailer = opts.sifTrailer ?? Uint8Array.from([]);\r\n    this.sifGuard = new SifGuard();\r\n  }\r\n\r\n  /**\r\n   * Assign a different participant to the cryptor.\r\n   * useful for transceiver re-use\r\n   * @param id\r\n   * @param keys\r\n   */\r\n  setParticipant(id: string, keys: ParticipantKeyHandler) {\r\n    this.participantIdentity = id;\r\n    this.keys = keys;\r\n    this.sifGuard.reset();\r\n  }\r\n\r\n  unsetParticipant() {\r\n    this.participantIdentity = undefined;\r\n  }\r\n\r\n  isEnabled() {\r\n    if (this.participantIdentity) {\r\n      return encryptionEnabledMap.get(this.participantIdentity);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  getParticipantIdentity() {\r\n    return this.participantIdentity;\r\n  }\r\n\r\n  getTrackId() {\r\n    return this.trackId;\r\n  }\r\n\r\n  /**\r\n   * Update the video codec used by the mediaStreamTrack\r\n   * @param codec\r\n   */\r\n  setVideoCodec(codec: VideoCodec) {\r\n    this.videoCodec = codec;\r\n  }\r\n\r\n  /**\r\n   * rtp payload type map used for figuring out codec of payload type when encoding\r\n   * @param map\r\n   */\r\n  setRtpMap(map: Map<number, VideoCodec>) {\r\n    this.rtpMap = map;\r\n  }\r\n\r\n  setupTransform(\r\n    operation: 'encode' | 'decode',\r\n    readable: ReadableStream,\r\n    writable: WritableStream,\r\n    trackId: string,\r\n    codec?: VideoCodec,\r\n  ) {\r\n    if (codec) {\r\n      workerLogger.info('setting codec on cryptor to', { codec });\r\n      this.videoCodec = codec;\r\n    }\r\n\r\n    const transformFn = operation === 'encode' ? this.encodeFunction : this.decodeFunction;\r\n    const transformStream = new TransformStream({\r\n      transform: transformFn.bind(this),\r\n    });\r\n\r\n    readable\r\n      .pipeThrough(transformStream)\r\n      .pipeTo(writable)\r\n      .catch((e) => {\r\n        workerLogger.warn(e);\r\n        this.emit(CryptorEvent.Error, e instanceof CryptorError ? e : new CryptorError(e.message));\r\n      });\r\n    this.trackId = trackId;\r\n  }\r\n\r\n  setSifTrailer(trailer: Uint8Array) {\r\n    this.sifTrailer = trailer;\r\n  }\r\n\r\n  /**\r\n   * Function that will be injected in a stream and will encrypt the given encoded frames.\r\n   *\r\n   * @param {RTCEncodedVideoFrame|RTCEncodedAudioFrame} encodedFrame - Encoded video frame.\r\n   * @param {TransformStreamDefaultController} controller - TransportStreamController.\r\n   *\r\n   * The VP8 payload descriptor described in\r\n   * https://tools.ietf.org/html/rfc7741#section-4.2\r\n   * is part of the RTP packet and not part of the frame and is not controllable by us.\r\n   * This is fine as the SFU keeps having access to it for routing.\r\n   *\r\n   * The encrypted frame is formed as follows:\r\n   * 1) Find unencrypted byte length, depending on the codec, frame type and kind.\r\n   * 2) Form the GCM IV for the frame as described above.\r\n   * 3) Encrypt the rest of the frame using AES-GCM.\r\n   * 4) Allocate space for the encrypted frame.\r\n   * 5) Copy the unencrypted bytes to the start of the encrypted frame.\r\n   * 6) Append the ciphertext to the encrypted frame.\r\n   * 7) Append the IV.\r\n   * 8) Append a single byte for the key identifier.\r\n   * 9) Enqueue the encrypted frame for sending.\r\n   */\r\n  protected async encodeFunction(\r\n    encodedFrame: RTCEncodedVideoFrame | RTCEncodedAudioFrame,\r\n    controller: TransformStreamDefaultController,\r\n  ) {\r\n    if (\r\n      !this.isEnabled() ||\r\n      // skip for encryption for empty dtx frames\r\n      encodedFrame.data.byteLength === 0\r\n    ) {\r\n      return controller.enqueue(encodedFrame);\r\n    }\r\n    const keySet = this.keys.getKeySet();\r\n    if (!keySet) {\r\n      throw new TypeError(\r\n        `key set not found for ${\r\n          this.participantIdentity\r\n        } at index ${this.keys.getCurrentKeyIndex()}`,\r\n      );\r\n    }\r\n    const { encryptionKey } = keySet;\r\n    const keyIndex = this.keys.getCurrentKeyIndex();\r\n\r\n    if (encryptionKey) {\r\n      const iv = this.makeIV(\r\n        encodedFrame.getMetadata().synchronizationSource ?? -1,\r\n        encodedFrame.timestamp,\r\n      );\r\n      let frameInfo = this.getUnencryptedBytes(encodedFrame);\r\n      // Ths is not encrypted and contains the VP8 payload descriptor or the Opus TOC byte.\r\n      const frameHeader = new Uint8Array(encodedFrame.data, 0, frameInfo.unencryptedBytes);\r\n\r\n      // Frame trailer contains the R|IV_LENGTH and key index\r\n      const frameTrailer = new Uint8Array(2);\r\n\r\n      frameTrailer[0] = IV_LENGTH;\r\n      frameTrailer[1] = keyIndex;\r\n\r\n      // Construct frame trailer. Similar to the frame header described in\r\n      // https://tools.ietf.org/html/draft-omara-sframe-00#section-4.2\r\n      // but we put it at the end.\r\n      //\r\n      // ---------+-------------------------+-+---------+----\r\n      // payload  |IV...(length = IV_LENGTH)|R|IV_LENGTH|KID |\r\n      // ---------+-------------------------+-+---------+----\r\n      try {\r\n        const cipherText = await crypto.subtle.encrypt(\r\n          {\r\n            name: ENCRYPTION_ALGORITHM,\r\n            iv,\r\n            additionalData: new Uint8Array(encodedFrame.data, 0, frameHeader.byteLength),\r\n          },\r\n          encryptionKey,\r\n          new Uint8Array(encodedFrame.data, frameInfo.unencryptedBytes),\r\n        );\r\n\r\n        let newDataWithoutHeader = new Uint8Array(\r\n          cipherText.byteLength + iv.byteLength + frameTrailer.byteLength,\r\n        );\r\n        newDataWithoutHeader.set(new Uint8Array(cipherText)); // add ciphertext.\r\n        newDataWithoutHeader.set(new Uint8Array(iv), cipherText.byteLength); // append IV.\r\n        newDataWithoutHeader.set(frameTrailer, cipherText.byteLength + iv.byteLength); // append frame trailer.\r\n\r\n        if (frameInfo.isH264) {\r\n          newDataWithoutHeader = writeRbsp(newDataWithoutHeader);\r\n        }\r\n\r\n        var newData = new Uint8Array(frameHeader.byteLength + newDataWithoutHeader.byteLength);\r\n        newData.set(frameHeader);\r\n        newData.set(newDataWithoutHeader, frameHeader.byteLength);\r\n\r\n        encodedFrame.data = newData.buffer;\r\n\r\n        return controller.enqueue(encodedFrame);\r\n      } catch (e: any) {\r\n        // TODO: surface this to the app.\r\n        workerLogger.error(e);\r\n      }\r\n    } else {\r\n      this.emit(\r\n        CryptorEvent.Error,\r\n        new CryptorError(`encryption key missing for encoding`, CryptorErrorReason.MissingKey),\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Function that will be injected in a stream and will decrypt the given encoded frames.\r\n   *\r\n   * @param {RTCEncodedVideoFrame|RTCEncodedAudioFrame} encodedFrame - Encoded video frame.\r\n   * @param {TransformStreamDefaultController} controller - TransportStreamController.\r\n   */\r\n  protected async decodeFunction(\r\n    encodedFrame: RTCEncodedVideoFrame | RTCEncodedAudioFrame,\r\n    controller: TransformStreamDefaultController,\r\n  ) {\r\n    if (\r\n      !this.isEnabled() ||\r\n      // skip for decryption for empty dtx frames\r\n      encodedFrame.data.byteLength === 0\r\n    ) {\r\n      this.sifGuard.recordUserFrame();\r\n      return controller.enqueue(encodedFrame);\r\n    }\r\n\r\n    if (isFrameServerInjected(encodedFrame.data, this.sifTrailer)) {\r\n      this.sifGuard.recordSif();\r\n\r\n      if (this.sifGuard.isSifAllowed()) {\r\n        encodedFrame.data = encodedFrame.data.slice(\r\n          0,\r\n          encodedFrame.data.byteLength - this.sifTrailer.byteLength,\r\n        );\r\n        return controller.enqueue(encodedFrame);\r\n      } else {\r\n        workerLogger.warn('SIF limit reached, dropping frame');\r\n        return;\r\n      }\r\n    } else {\r\n      this.sifGuard.recordUserFrame();\r\n    }\r\n    const data = new Uint8Array(encodedFrame.data);\r\n    const keyIndex = data[encodedFrame.data.byteLength - 1];\r\n\r\n    if (this.keys.getKeySet(keyIndex) && this.keys.hasValidKey) {\r\n      try {\r\n        const decodedFrame = await this.decryptFrame(encodedFrame, keyIndex);\r\n        this.keys.decryptionSuccess();\r\n        if (decodedFrame) {\r\n          return controller.enqueue(decodedFrame);\r\n        }\r\n      } catch (error) {\r\n        if (error instanceof CryptorError && error.reason === CryptorErrorReason.InvalidKey) {\r\n          if (this.keys.hasValidKey) {\r\n            this.emit(CryptorEvent.Error, error);\r\n            this.keys.decryptionFailure();\r\n          }\r\n        } else {\r\n          workerLogger.warn('decoding frame failed', { error });\r\n        }\r\n      }\r\n    } else if (!this.keys.getKeySet(keyIndex) && this.keys.hasValidKey) {\r\n      // emit an error in case the key index is out of bounds but the key handler thinks we still have a valid key\r\n      workerLogger.warn('skipping decryption due to missing key at index');\r\n      this.emit(\r\n        CryptorEvent.Error,\r\n        new CryptorError(\r\n          `missing key at index for participant ${this.participantIdentity}`,\r\n          CryptorErrorReason.MissingKey,\r\n        ),\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Function that will decrypt the given encoded frame. If the decryption fails, it will\r\n   * ratchet the key for up to RATCHET_WINDOW_SIZE times.\r\n   */\r\n  private async decryptFrame(\r\n    encodedFrame: RTCEncodedVideoFrame | RTCEncodedAudioFrame,\r\n    keyIndex: number,\r\n    initialMaterial: KeySet | undefined = undefined,\r\n    ratchetOpts: DecodeRatchetOptions = { ratchetCount: 0 },\r\n  ): Promise<RTCEncodedVideoFrame | RTCEncodedAudioFrame | undefined> {\r\n    const keySet = this.keys.getKeySet(keyIndex);\r\n    if (!ratchetOpts.encryptionKey && !keySet) {\r\n      throw new TypeError(`no encryption key found for decryption of ${this.participantIdentity}`);\r\n    }\r\n    let frameInfo = this.getUnencryptedBytes(encodedFrame);\r\n    // Construct frame trailer. Similar to the frame header described in\r\n    // https://tools.ietf.org/html/draft-omara-sframe-00#section-4.2\r\n    // but we put it at the end.\r\n    //\r\n    // ---------+-------------------------+-+---------+----\r\n    // payload  |IV...(length = IV_LENGTH)|R|IV_LENGTH|KID |\r\n    // ---------+-------------------------+-+---------+----\r\n\r\n    try {\r\n      const frameHeader = new Uint8Array(encodedFrame.data, 0, frameInfo.unencryptedBytes);\r\n      var encryptedData = new Uint8Array(\r\n        encodedFrame.data,\r\n        frameHeader.length,\r\n        encodedFrame.data.byteLength - frameHeader.length,\r\n      );\r\n      if (frameInfo.isH264 && needsRbspUnescaping(encryptedData)) {\r\n        encryptedData = parseRbsp(encryptedData);\r\n        const newUint8 = new Uint8Array(frameHeader.byteLength + encryptedData.byteLength);\r\n        newUint8.set(frameHeader);\r\n        newUint8.set(encryptedData, frameHeader.byteLength);\r\n        encodedFrame.data = newUint8.buffer;\r\n      }\r\n\r\n      const frameTrailer = new Uint8Array(encodedFrame.data, encodedFrame.data.byteLength - 2, 2);\r\n\r\n      const ivLength = frameTrailer[0];\r\n      const iv = new Uint8Array(\r\n        encodedFrame.data,\r\n        encodedFrame.data.byteLength - ivLength - frameTrailer.byteLength,\r\n        ivLength,\r\n      );\r\n\r\n      const cipherTextStart = frameHeader.byteLength;\r\n      const cipherTextLength =\r\n        encodedFrame.data.byteLength -\r\n        (frameHeader.byteLength + ivLength + frameTrailer.byteLength);\r\n\r\n      const plainText = await crypto.subtle.decrypt(\r\n        {\r\n          name: ENCRYPTION_ALGORITHM,\r\n          iv,\r\n          additionalData: new Uint8Array(encodedFrame.data, 0, frameHeader.byteLength),\r\n        },\r\n        ratchetOpts.encryptionKey ?? keySet!.encryptionKey,\r\n        new Uint8Array(encodedFrame.data, cipherTextStart, cipherTextLength),\r\n      );\r\n\r\n      const newData = new ArrayBuffer(frameHeader.byteLength + plainText.byteLength);\r\n      const newUint8 = new Uint8Array(newData);\r\n\r\n      newUint8.set(new Uint8Array(encodedFrame.data, 0, frameHeader.byteLength));\r\n      newUint8.set(new Uint8Array(plainText), frameHeader.byteLength);\r\n\r\n      encodedFrame.data = newData;\r\n\r\n      return encodedFrame;\r\n    } catch (error: any) {\r\n      if (this.keyProviderOptions.ratchetWindowSize > 0) {\r\n        if (ratchetOpts.ratchetCount < this.keyProviderOptions.ratchetWindowSize) {\r\n          workerLogger.debug(\r\n            `ratcheting key attempt ${ratchetOpts.ratchetCount} of ${\r\n              this.keyProviderOptions.ratchetWindowSize\r\n            }, for kind ${encodedFrame instanceof RTCEncodedAudioFrame ? 'audio' : 'video'}`,\r\n          );\r\n\r\n          let ratchetedKeySet: KeySet | undefined;\r\n          if (keySet === this.keys.getKeySet(keyIndex)) {\r\n            // only ratchet if the currently set key is still the same as the one used to decrypt this frame\r\n            // if not, it might be that a different frame has already ratcheted and we try with that one first\r\n            const newMaterial = await this.keys.ratchetKey(keyIndex, false);\r\n\r\n            ratchetedKeySet = await deriveKeys(newMaterial, this.keyProviderOptions.ratchetSalt);\r\n          }\r\n\r\n          const frame = await this.decryptFrame(encodedFrame, keyIndex, initialMaterial || keySet, {\r\n            ratchetCount: ratchetOpts.ratchetCount + 1,\r\n            encryptionKey: ratchetedKeySet?.encryptionKey,\r\n          });\r\n          if (frame && ratchetedKeySet) {\r\n            this.keys.setKeySet(ratchetedKeySet, keyIndex, true);\r\n            // decryption was successful, set the new key index to reflect the ratcheted key set\r\n            this.keys.setCurrentKeyIndex(keyIndex);\r\n          }\r\n          return frame;\r\n        } else {\r\n          /**\r\n           * Since the key it is first send and only afterwards actually used for encrypting, there were\r\n           * situations when the decrypting failed due to the fact that the received frame was not encrypted\r\n           * yet and ratcheting, of course, did not solve the problem. So if we fail RATCHET_WINDOW_SIZE times,\r\n           * we come back to the initial key.\r\n           */\r\n          if (initialMaterial) {\r\n            workerLogger.debug('resetting to initial material');\r\n            this.keys.setKeyFromMaterial(initialMaterial.material, keyIndex);\r\n          }\r\n\r\n          workerLogger.warn('maximum ratchet attempts exceeded');\r\n          throw new CryptorError(\r\n            `valid key missing for participant ${this.participantIdentity}`,\r\n            CryptorErrorReason.InvalidKey,\r\n          );\r\n        }\r\n      } else {\r\n        throw new CryptorError(\r\n          `Decryption failed: ${error.message}`,\r\n          CryptorErrorReason.InvalidKey,\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Construct the IV used for AES-GCM and sent (in plain) with the packet similar to\r\n   * https://tools.ietf.org/html/rfc7714#section-8.1\r\n   * It concatenates\r\n   * - the 32 bit synchronization source (SSRC) given on the encoded frame,\r\n   * - the 32 bit rtp timestamp given on the encoded frame,\r\n   * - a send counter that is specific to the SSRC. Starts at a random number.\r\n   * The send counter is essentially the pictureId but we currently have to implement this ourselves.\r\n   * There is no XOR with a salt. Note that this IV leaks the SSRC to the receiver but since this is\r\n   * randomly generated and SFUs may not rewrite this is considered acceptable.\r\n   * The SSRC is used to allow demultiplexing multiple streams with the same key, as described in\r\n   *   https://tools.ietf.org/html/rfc3711#section-4.1.1\r\n   * The RTP timestamp is 32 bits and advances by the codec clock rate (90khz for video, 48khz for\r\n   * opus audio) every second. For video it rolls over roughly every 13 hours.\r\n   * The send counter will advance at the frame rate (30fps for video, 50fps for 20ms opus audio)\r\n   * every second. It will take a long time to roll over.\r\n   *\r\n   * See also https://developer.mozilla.org/en-US/docs/Web/API/AesGcmParams\r\n   */\r\n  private makeIV(synchronizationSource: number, timestamp: number) {\r\n    const iv = new ArrayBuffer(IV_LENGTH);\r\n    const ivView = new DataView(iv);\r\n\r\n    // having to keep our own send count (similar to a picture id) is not ideal.\r\n    if (!this.sendCounts.has(synchronizationSource)) {\r\n      // Initialize with a random offset, similar to the RTP sequence number.\r\n      this.sendCounts.set(synchronizationSource, Math.floor(Math.random() * 0xffff));\r\n    }\r\n\r\n    const sendCount = this.sendCounts.get(synchronizationSource) ?? 0;\r\n\r\n    ivView.setUint32(0, synchronizationSource);\r\n    ivView.setUint32(4, timestamp);\r\n    ivView.setUint32(8, timestamp - (sendCount % 0xffff));\r\n\r\n    this.sendCounts.set(synchronizationSource, sendCount + 1);\r\n\r\n    return iv;\r\n  }\r\n\r\n  private getUnencryptedBytes(frame: RTCEncodedVideoFrame | RTCEncodedAudioFrame): {\r\n    unencryptedBytes: number;\r\n    isH264: boolean;\r\n  } {\r\n    var frameInfo = { unencryptedBytes: 0, isH264: false };\r\n    if (isVideoFrame(frame)) {\r\n      let detectedCodec = this.getVideoCodec(frame) ?? this.videoCodec;\r\n\r\n      if (detectedCodec === 'av1' || detectedCodec === 'vp9') {\r\n        throw new Error(`${detectedCodec} is not yet supported for end to end encryption`);\r\n      }\r\n\r\n      if (detectedCodec === 'vp8') {\r\n        frameInfo.unencryptedBytes = UNENCRYPTED_BYTES[frame.type];\r\n        return frameInfo;\r\n      }\r\n\r\n      const data = new Uint8Array(frame.data);\r\n      try {\r\n        const naluIndices = findNALUIndices(data);\r\n\r\n        // if the detected codec is undefined we test whether it _looks_ like a h264 frame as a best guess\r\n        frameInfo.isH264 =\r\n          detectedCodec === 'h264' ||\r\n          naluIndices.some((naluIndex) =>\r\n            [NALUType.SLICE_IDR, NALUType.SLICE_NON_IDR].includes(parseNALUType(data[naluIndex])),\r\n          );\r\n\r\n        if (frameInfo.isH264) {\r\n          for (const index of naluIndices) {\r\n            let type = parseNALUType(data[index]);\r\n            switch (type) {\r\n              case NALUType.SLICE_IDR:\r\n              case NALUType.SLICE_NON_IDR:\r\n                frameInfo.unencryptedBytes = index + 2;\r\n                return frameInfo;\r\n              default:\r\n                break;\r\n            }\r\n          }\r\n          throw new TypeError('Could not find NALU');\r\n        }\r\n      } catch (e) {\r\n        // no op, we just continue and fallback to vp8\r\n      }\r\n\r\n      frameInfo.unencryptedBytes = UNENCRYPTED_BYTES[frame.type];\r\n      return frameInfo;\r\n    } else {\r\n      frameInfo.unencryptedBytes = UNENCRYPTED_BYTES.audio;\r\n      return frameInfo;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * inspects frame payloadtype if available and maps it to the codec specified in rtpMap\r\n   */\r\n  private getVideoCodec(frame: RTCEncodedVideoFrame): VideoCodec | undefined {\r\n    if (this.rtpMap.size === 0) {\r\n      return undefined;\r\n    }\r\n    // @ts-expect-error payloadType is not yet part of the typescript definition and currently not supported in Safari\r\n    const payloadType = frame.getMetadata().payloadType;\r\n    const codec = payloadType ? this.rtpMap.get(payloadType) : undefined;\r\n    return codec;\r\n  }\r\n}\r\n\r\n/**\r\n * Slice the NALUs present in the supplied buffer, assuming it is already byte-aligned\r\n * code adapted from https://github.com/medooze/h264-frame-parser/blob/main/lib/NalUnits.ts to return indices only\r\n */\r\nexport function findNALUIndices(stream: Uint8Array): number[] {\r\n  const result: number[] = [];\r\n  let start = 0,\r\n    pos = 0,\r\n    searchLength = stream.length - 2;\r\n  while (pos < searchLength) {\r\n    // skip until end of current NALU\r\n    while (\r\n      pos < searchLength &&\r\n      !(stream[pos] === 0 && stream[pos + 1] === 0 && stream[pos + 2] === 1)\r\n    )\r\n      pos++;\r\n    if (pos >= searchLength) pos = stream.length;\r\n    // remove trailing zeros from current NALU\r\n    let end = pos;\r\n    while (end > start && stream[end - 1] === 0) end--;\r\n    // save current NALU\r\n    if (start === 0) {\r\n      if (end !== start) throw TypeError('byte stream contains leading data');\r\n    } else {\r\n      result.push(start);\r\n    }\r\n    // begin new NALU\r\n    start = pos = pos + 3;\r\n  }\r\n  return result;\r\n}\r\n\r\nexport function parseNALUType(startByte: number): NALUType {\r\n  return startByte & kNaluTypeMask;\r\n}\r\n\r\nconst kNaluTypeMask = 0x1f;\r\n\r\nexport enum NALUType {\r\n  /** Coded slice of a non-IDR picture */\r\n  SLICE_NON_IDR = 1,\r\n  /** Coded slice data partition A */\r\n  SLICE_PARTITION_A = 2,\r\n  /** Coded slice data partition B */\r\n  SLICE_PARTITION_B = 3,\r\n  /** Coded slice data partition C */\r\n  SLICE_PARTITION_C = 4,\r\n  /** Coded slice of an IDR picture */\r\n  SLICE_IDR = 5,\r\n  /** Supplemental enhancement information */\r\n  SEI = 6,\r\n  /** Sequence parameter set */\r\n  SPS = 7,\r\n  /** Picture parameter set */\r\n  PPS = 8,\r\n  /** Access unit delimiter */\r\n  AUD = 9,\r\n  /** End of sequence */\r\n  END_SEQ = 10,\r\n  /** End of stream */\r\n  END_STREAM = 11,\r\n  /** Filler data */\r\n  FILLER_DATA = 12,\r\n  /** Sequence parameter set extension */\r\n  SPS_EXT = 13,\r\n  /** Prefix NAL unit */\r\n  PREFIX_NALU = 14,\r\n  /** Subset sequence parameter set */\r\n  SUBSET_SPS = 15,\r\n  /** Depth parameter set */\r\n  DPS = 16,\r\n\r\n  // 17, 18 reserved\r\n\r\n  /** Coded slice of an auxiliary coded picture without partitioning */\r\n  SLICE_AUX = 19,\r\n  /** Coded slice extension */\r\n  SLICE_EXT = 20,\r\n  /** Coded slice extension for a depth view component or a 3D-AVC texture view component */\r\n  SLICE_LAYER_EXT = 21,\r\n\r\n  // 22, 23 reserved\r\n}\r\n\r\n/**\r\n * we use a magic frame trailer to detect whether a frame is injected\r\n * by the livekit server and thus to be treated as unencrypted\r\n * @internal\r\n */\r\nexport function isFrameServerInjected(frameData: ArrayBuffer, trailerBytes: Uint8Array): boolean {\r\n  if (trailerBytes.byteLength === 0) {\r\n    return false;\r\n  }\r\n  const frameTrailer = new Uint8Array(\r\n    frameData.slice(frameData.byteLength - trailerBytes.byteLength),\r\n  );\r\n  return trailerBytes.every((value, index) => value === frameTrailer[index]);\r\n}\r\n","import { EventEmitter } from 'events';\r\nimport type TypedEventEmitter from 'typed-emitter';\r\nimport { workerLogger } from '../../logger';\r\nimport { KEYRING_SIZE } from '../constants';\r\nimport { KeyHandlerEvent, type ParticipantKeyHandlerCallbacks } from '../events';\r\nimport type { KeyProviderOptions, KeySet } from '../types';\r\nimport { deriveKeys, importKey, ratchet } from '../utils';\r\n\r\n// TODO ParticipantKeyHandlers currently don't get destroyed on participant disconnect\r\n// we could do this by having a separate worker message on participant disconnected.\r\n\r\n/**\r\n * ParticipantKeyHandler is responsible for providing a cryptor instance with the\r\n * en-/decryption key of a participant. It assumes that all tracks of a specific participant\r\n * are encrypted with the same key.\r\n * Additionally it exposes a method to ratchet a key which can be used by the cryptor either automatically\r\n * if decryption fails or can be triggered manually on both sender and receiver side.\r\n *\r\n */\r\nexport class ParticipantKeyHandler extends (EventEmitter as new () => TypedEventEmitter<ParticipantKeyHandlerCallbacks>) {\r\n  private currentKeyIndex: number;\r\n\r\n  private cryptoKeyRing: Array<KeySet | undefined>;\r\n\r\n  private keyProviderOptions: KeyProviderOptions;\r\n\r\n  private ratchetPromiseMap: Map<number, Promise<CryptoKey>>;\r\n\r\n  private participantIdentity: string;\r\n\r\n  private decryptionFailureCount = 0;\r\n\r\n  private _hasValidKey: boolean = true;\r\n\r\n  get hasValidKey() {\r\n    return this._hasValidKey;\r\n  }\r\n\r\n  constructor(participantIdentity: string, keyProviderOptions: KeyProviderOptions) {\r\n    super();\r\n    this.currentKeyIndex = 0;\r\n    this.cryptoKeyRing = new Array(KEYRING_SIZE).fill(undefined);\r\n    this.keyProviderOptions = keyProviderOptions;\r\n    this.ratchetPromiseMap = new Map();\r\n    this.participantIdentity = participantIdentity;\r\n    this.resetKeyStatus();\r\n  }\r\n\r\n  decryptionFailure() {\r\n    if (this.keyProviderOptions.failureTolerance < 0) {\r\n      return;\r\n    }\r\n    this.decryptionFailureCount += 1;\r\n\r\n    if (this.decryptionFailureCount > this.keyProviderOptions.failureTolerance) {\r\n      workerLogger.warn(`key for ${this.participantIdentity} is being marked as invalid`);\r\n      this._hasValidKey = false;\r\n    }\r\n  }\r\n\r\n  decryptionSuccess() {\r\n    this.resetKeyStatus();\r\n  }\r\n\r\n  /**\r\n   * Call this after user initiated ratchet or a new key has been set in order to make sure to mark potentially\r\n   * invalid keys as valid again\r\n   */\r\n  resetKeyStatus() {\r\n    this.decryptionFailureCount = 0;\r\n    this._hasValidKey = true;\r\n  }\r\n\r\n  /**\r\n   * Ratchets the current key (or the one at keyIndex if provided) and\r\n   * returns the ratcheted material\r\n   * if `setKey` is true (default), it will also set the ratcheted key directly on the crypto key ring\r\n   * @param keyIndex\r\n   * @param setKey\r\n   */\r\n  ratchetKey(keyIndex?: number, setKey = true): Promise<CryptoKey> {\r\n    const currentKeyIndex = keyIndex ?? this.getCurrentKeyIndex();\r\n\r\n    const existingPromise = this.ratchetPromiseMap.get(currentKeyIndex);\r\n    if (typeof existingPromise !== 'undefined') {\r\n      return existingPromise;\r\n    }\r\n    const ratchetPromise = new Promise<CryptoKey>(async (resolve, reject) => {\r\n      try {\r\n        const keySet = this.getKeySet(currentKeyIndex);\r\n        if (!keySet) {\r\n          throw new TypeError(\r\n            `Cannot ratchet key without a valid keyset of participant ${this.participantIdentity}`,\r\n          );\r\n        }\r\n        const currentMaterial = keySet.material;\r\n        const newMaterial = await importKey(\r\n          await ratchet(currentMaterial, this.keyProviderOptions.ratchetSalt),\r\n          currentMaterial.algorithm.name,\r\n          'derive',\r\n        );\r\n\r\n        if (setKey) {\r\n          this.setKeyFromMaterial(newMaterial, currentKeyIndex, true);\r\n          this.emit(\r\n            KeyHandlerEvent.KeyRatcheted,\r\n            newMaterial,\r\n            this.participantIdentity,\r\n            currentKeyIndex,\r\n          );\r\n        }\r\n        resolve(newMaterial);\r\n      } catch (e) {\r\n        reject(e);\r\n      } finally {\r\n        this.ratchetPromiseMap.delete(currentKeyIndex);\r\n      }\r\n    });\r\n    this.ratchetPromiseMap.set(currentKeyIndex, ratchetPromise);\r\n    return ratchetPromise;\r\n  }\r\n\r\n  /**\r\n   * takes in a key material with `deriveBits` and `deriveKey` set as key usages\r\n   * and derives encryption keys from the material and sets it on the key ring buffer\r\n   * together with the material\r\n   * also resets the valid key property and updates the currentKeyIndex\r\n   */\r\n  async setKey(material: CryptoKey, keyIndex = 0) {\r\n    await this.setKeyFromMaterial(material, keyIndex);\r\n    this.resetKeyStatus();\r\n  }\r\n\r\n  /**\r\n   * takes in a key material with `deriveBits` and `deriveKey` set as key usages\r\n   * and derives encryption keys from the material and sets it on the key ring buffer\r\n   * together with the material\r\n   * also updates the currentKeyIndex\r\n   */\r\n  async setKeyFromMaterial(material: CryptoKey, keyIndex = 0, emitRatchetEvent = false) {\r\n    workerLogger.debug('setting new key');\r\n    if (keyIndex >= 0) {\r\n      this.currentKeyIndex = keyIndex % this.cryptoKeyRing.length;\r\n    }\r\n    const keySet = await deriveKeys(material, this.keyProviderOptions.ratchetSalt);\r\n    this.setKeySet(keySet, this.currentKeyIndex, emitRatchetEvent);\r\n  }\r\n\r\n  setKeySet(keySet: KeySet, keyIndex: number, emitRatchetEvent = false) {\r\n    this.cryptoKeyRing[keyIndex % this.cryptoKeyRing.length] = keySet;\r\n\r\n    if (emitRatchetEvent) {\r\n      this.emit(KeyHandlerEvent.KeyRatcheted, keySet.material, this.participantIdentity, keyIndex);\r\n    }\r\n  }\r\n\r\n  async setCurrentKeyIndex(index: number) {\r\n    this.currentKeyIndex = index % this.cryptoKeyRing.length;\r\n    this.resetKeyStatus();\r\n  }\r\n\r\n  getCurrentKeyIndex() {\r\n    return this.currentKeyIndex;\r\n  }\r\n\r\n  /**\r\n   * returns currently used KeySet or the one at `keyIndex` if provided\r\n   * @param keyIndex\r\n   * @returns\r\n   */\r\n  getKeySet(keyIndex?: number) {\r\n    return this.cryptoKeyRing[keyIndex ?? this.currentKeyIndex];\r\n  }\r\n}\r\n","import { workerLogger } from '../../logger';\r\nimport { KEY_PROVIDER_DEFAULTS } from '../constants';\r\nimport { CryptorErrorReason } from '../errors';\r\nimport { CryptorEvent, KeyHandlerEvent } from '../events';\r\nimport type {\r\n  E2EEWorkerMessage,\r\n  ErrorMessage,\r\n  InitAck,\r\n  KeyProviderOptions,\r\n  RatchetMessage,\r\n  RatchetRequestMessage,\r\n} from '../types';\r\nimport { FrameCryptor, encryptionEnabledMap } from './FrameCryptor';\r\nimport { ParticipantKeyHandler } from './ParticipantKeyHandler';\r\n\r\nconst participantCryptors: FrameCryptor[] = [];\r\nconst participantKeys: Map<string, ParticipantKeyHandler> = new Map();\r\nlet sharedKeyHandler: ParticipantKeyHandler | undefined;\r\n\r\nlet isEncryptionEnabled: boolean = false;\r\n\r\nlet useSharedKey: boolean = false;\r\n\r\nlet sharedKey: CryptoKey | undefined;\r\n\r\nlet sifTrailer: Uint8Array | undefined;\r\n\r\nlet keyProviderOptions: KeyProviderOptions = KEY_PROVIDER_DEFAULTS;\r\n\r\nworkerLogger.setDefaultLevel('info');\r\n\r\nonmessage = (ev) => {\r\n  const { kind, data }: E2EEWorkerMessage = ev.data;\r\n\r\n  switch (kind) {\r\n    case 'init':\r\n      workerLogger.info('worker initialized');\r\n      keyProviderOptions = data.keyProviderOptions;\r\n      useSharedKey = !!data.keyProviderOptions.sharedKey;\r\n      // acknowledge init successful\r\n      const ackMsg: InitAck = {\r\n        kind: 'initAck',\r\n        data: { enabled: isEncryptionEnabled },\r\n      };\r\n      postMessage(ackMsg);\r\n      break;\r\n    case 'enable':\r\n      setEncryptionEnabled(data.enabled, data.participantIdentity);\r\n      workerLogger.info('updated e2ee enabled status');\r\n      // acknowledge enable call successful\r\n      postMessage(ev.data);\r\n      break;\r\n    case 'decode':\r\n      let cryptor = getTrackCryptor(data.participantIdentity, data.trackId);\r\n      cryptor.setupTransform(\r\n        kind,\r\n        data.readableStream,\r\n        data.writableStream,\r\n        data.trackId,\r\n        data.codec,\r\n      );\r\n      break;\r\n    case 'encode':\r\n      let pubCryptor = getTrackCryptor(data.participantIdentity, data.trackId);\r\n      pubCryptor.setupTransform(\r\n        kind,\r\n        data.readableStream,\r\n        data.writableStream,\r\n        data.trackId,\r\n        data.codec,\r\n      );\r\n      break;\r\n    case 'setKey':\r\n      if (useSharedKey) {\r\n        workerLogger.warn('set shared key');\r\n        setSharedKey(data.key, data.keyIndex);\r\n      } else if (data.participantIdentity) {\r\n        workerLogger.warn(`set participant sender key ${data.participantIdentity}`);\r\n        getParticipantKeyHandler(data.participantIdentity).setKey(data.key, data.keyIndex);\r\n      } else {\r\n        workerLogger.error('no participant Id was provided and shared key usage is disabled');\r\n      }\r\n      break;\r\n    case 'removeTransform':\r\n      unsetCryptorParticipant(data.trackId);\r\n      break;\r\n    case 'updateCodec':\r\n      getTrackCryptor(data.participantIdentity, data.trackId).setVideoCodec(data.codec);\r\n      break;\r\n    case 'setRTPMap':\r\n      // this is only used for the local participant\r\n      participantCryptors.forEach((cr) => {\r\n        if (cr.getParticipantIdentity() === data.participantIdentity) {\r\n          cr.setRtpMap(data.map);\r\n        }\r\n      });\r\n      break;\r\n    case 'ratchetRequest':\r\n      handleRatchetRequest(data);\r\n      break;\r\n    case 'setSifTrailer':\r\n      handleSifTrailer(data.trailer);\r\n      break;\r\n    default:\r\n      break;\r\n  }\r\n};\r\n\r\nasync function handleRatchetRequest(data: RatchetRequestMessage['data']) {\r\n  if (useSharedKey) {\r\n    const keyHandler = getSharedKeyHandler();\r\n    await keyHandler.ratchetKey(data.keyIndex);\r\n    keyHandler.resetKeyStatus();\r\n  } else if (data.participantIdentity) {\r\n    const keyHandler = getParticipantKeyHandler(data.participantIdentity);\r\n    await keyHandler.ratchetKey(data.keyIndex);\r\n    keyHandler.resetKeyStatus();\r\n  } else {\r\n    workerLogger.error(\r\n      'no participant Id was provided for ratchet request and shared key usage is disabled',\r\n    );\r\n  }\r\n}\r\n\r\nfunction getTrackCryptor(participantIdentity: string, trackId: string) {\r\n  let cryptor = participantCryptors.find((c) => c.getTrackId() === trackId);\r\n  if (!cryptor) {\r\n    workerLogger.info('creating new cryptor for', { participantIdentity });\r\n    if (!keyProviderOptions) {\r\n      throw Error('Missing keyProvider options');\r\n    }\r\n    cryptor = new FrameCryptor({\r\n      participantIdentity,\r\n      keys: getParticipantKeyHandler(participantIdentity),\r\n      keyProviderOptions,\r\n      sifTrailer,\r\n    });\r\n\r\n    setupCryptorErrorEvents(cryptor);\r\n    participantCryptors.push(cryptor);\r\n  } else if (participantIdentity !== cryptor.getParticipantIdentity()) {\r\n    // assign new participant id to track cryptor and pass in correct key handler\r\n    cryptor.setParticipant(participantIdentity, getParticipantKeyHandler(participantIdentity));\r\n  }\r\n  if (sharedKey) {\r\n  }\r\n  return cryptor;\r\n}\r\n\r\nfunction getParticipantKeyHandler(participantIdentity: string) {\r\n  if (useSharedKey) {\r\n    return getSharedKeyHandler();\r\n  }\r\n  let keys = participantKeys.get(participantIdentity);\r\n  if (!keys) {\r\n    keys = new ParticipantKeyHandler(participantIdentity, keyProviderOptions);\r\n    if (sharedKey) {\r\n      keys.setKey(sharedKey);\r\n    }\r\n    keys.on(KeyHandlerEvent.KeyRatcheted, emitRatchetedKeys);\r\n    participantKeys.set(participantIdentity, keys);\r\n  }\r\n  return keys;\r\n}\r\n\r\nfunction getSharedKeyHandler() {\r\n  if (!sharedKeyHandler) {\r\n    sharedKeyHandler = new ParticipantKeyHandler('shared-key', keyProviderOptions);\r\n  }\r\n  return sharedKeyHandler;\r\n}\r\n\r\nfunction unsetCryptorParticipant(trackId: string) {\r\n  participantCryptors.find((c) => c.getTrackId() === trackId)?.unsetParticipant();\r\n}\r\n\r\nfunction setEncryptionEnabled(enable: boolean, participantIdentity: string) {\r\n  encryptionEnabledMap.set(participantIdentity, enable);\r\n}\r\n\r\nfunction setSharedKey(key: CryptoKey, index?: number) {\r\n  workerLogger.debug('setting shared key');\r\n  sharedKey = key;\r\n  getSharedKeyHandler().setKey(key, index);\r\n}\r\n\r\nfunction setupCryptorErrorEvents(cryptor: FrameCryptor) {\r\n  cryptor.on(CryptorEvent.Error, (error) => {\r\n    const msg: ErrorMessage = {\r\n      kind: 'error',\r\n      data: { error: new Error(`${CryptorErrorReason[error.reason]}: ${error.message}`) },\r\n    };\r\n    postMessage(msg);\r\n  });\r\n}\r\n\r\nfunction emitRatchetedKeys(material: CryptoKey, participantIdentity: string, keyIndex?: number) {\r\n  const msg: RatchetMessage = {\r\n    kind: `ratchetKey`,\r\n    data: {\r\n      participantIdentity,\r\n      keyIndex,\r\n      material,\r\n    },\r\n  };\r\n  postMessage(msg);\r\n}\r\n\r\nfunction handleSifTrailer(trailer: Uint8Array) {\r\n  sifTrailer = trailer;\r\n  participantCryptors.forEach((c) => {\r\n    c.setSifTrailer(trailer);\r\n  });\r\n}\r\n\r\n// Operations using RTCRtpScriptTransform.\r\n// @ts-ignore\r\nif (self.RTCTransformEvent) {\r\n  workerLogger.debug('setup transform event');\r\n  // @ts-ignore\r\n  self.onrtctransform = (event) => {\r\n    const transformer = event.transformer;\r\n    workerLogger.debug('transformer', transformer);\r\n    transformer.handled = true;\r\n    const { kind, participantIdentity, trackId, codec } = transformer.options;\r\n    const cryptor = getTrackCryptor(participantIdentity, trackId);\r\n    workerLogger.debug('transform', { codec });\r\n    cryptor.setupTransform(kind, transformer.readable, transformer.writable, trackId, codec);\r\n  };\r\n}\r\n"],"names":["root","definition","module","exports","log","this","noop","undefinedType","isIE","window","navigator","test","userAgent","logMethods","bindMethod","obj","methodName","method","bind","Function","prototype","call","e","apply","arguments","traceForIE","console","trace","realMethod","undefined","replaceLoggingMethods","level","loggerName","i","length","methodFactory","debug","enableLoggingWhenConsoleArrives","defaultMethodFactory","Logger","name","defaultLevel","factory","self","currentLevel","storageKey","persistLevelIfPossible","levelNum","levelName","toUpperCase","localStorage","ignore","document","cookie","encodeURIComponent","getPersistedLevel","storedLevel","location","indexOf","exec","slice","levels","clearPersistedLevel","removeItem","getLevel","setLevel","persist","SILENT","setDefaultLevel","resetLevel","enableAll","TRACE","disableAll","initialLevel","defaultLogger","_loggersByName","getLogger","TypeError","logger","_log","noConflict","getLoggers","LogLevel","livekitLogger","info","workerLogger","ENCRYPTION_ALGORITHM","KEYRING_SIZE","DECRYPTION_FAILURE_TOLERANCE","UNENCRYPTED_BYTES","key","delta","audio","empty","IV_LENGTH","SALT","KEY_PROVIDER_DEFAULTS","sharedKey","ratchetSalt","ratchetWindowSize","failureTolerance","MAX_SIF_COUNT","MAX_SIF_DURATION","LivekitError","Error","constructor","code","message","MediaDeviceFailure","getFailure","error","NotFound","PermissionDenied","DeviceInUse","Other","CryptorErrorReason","CryptorError","reason","InternalError","KeyProviderEvent","KeyHandlerEvent","EncryptionEvent","CryptorEvent","R","Reflect","ReflectApply","target","receiver","args","ReflectOwnKeys","ownKeys","Object","getOwnPropertySymbols","getOwnPropertyNames","concat","ProcessEmitWarning","warning","warn","NumberIsNaN","Number","isNaN","value","EventEmitter","init","eventsModule","once","_events","_eventsCount","_maxListeners","defaultMaxListeners","checkListener","listener","defineProperty","enumerable","get","set","arg","RangeError","getPrototypeOf","create","setMaxListeners","n","_getMaxListeners","that","getMaxListeners","emit","type","push","doError","events","er","err","context","handler","len","listeners","arrayClone","_addListener","prepend","m","existing","newListener","unshift","warned","w","String","emitter","count","addListener","on","prependListener","onceWrapper","fired","removeListener","wrapFn","_onceWrap","state","wrapped","prependOnceListener","list","position","originalListener","shift","spliceOne","off","removeAllListeners","keys","_listeners","unwrap","evlistener","unwrapListeners","rawListeners","listenerCount","eventNames","arr","copy","Array","index","pop","ret","Promise","resolve","reject","errorListener","resolver","eventTargetAgnosticAddListener","addErrorHandlerIfEventEmitter","flags","addEventListener","wrapListener","removeEventListener","AudioPresets","telephone","maxBitrate","speech","music","musicStereo","musicHighQuality","musicHighQualityStereo","isVideoFrame","frame","importKey","keyBytes","algorithm","usage","crypto","subtle","getAlgoOptions","algorithmName","salt","textEncoder","TextEncoder","encodedSalt","encode","hash","ArrayBuffer","iterations","deriveKeys","material","algorithmOptions","encryptionKey","deriveKey","ratchet","deriveBits","needsRbspUnescaping","frameData","parseRbsp","stream","dataOut","Uint8Array","kZerosInStartSequence","kEmulationByte","writeRbsp","data_in","numConsecutiveZeros","byte","SifGuard","consecutiveSifCount","lastSifReceivedAt","userFramesSinceSif","recordSif","_a","sifSequenceStartedAt","Date","now","recordUserFrame","reset","isSifAllowed","encryptionEnabledMap","Map","BaseFrameCryptor","encodeFunction","encodedFrame","controller","decodeFunction","FrameCryptor","opts","sendCounts","participantIdentity","rtpMap","keyProviderOptions","sifTrailer","from","sifGuard","setParticipant","id","unsetParticipant","isEnabled","getParticipantIdentity","getTrackId","trackId","setVideoCodec","codec","videoCodec","setRtpMap","map","setupTransform","operation","readable","writable","transformFn","transformStream","TransformStream","transform","pipeThrough","pipeTo","catch","setSifTrailer","trailer","data","byteLength","enqueue","keySet","getKeySet","getCurrentKeyIndex","keyIndex","iv","makeIV","getMetadata","synchronizationSource","timestamp","frameInfo","getUnencryptedBytes","frameHeader","unencryptedBytes","frameTrailer","cipherText","encrypt","additionalData","newDataWithoutHeader","isH264","newData","buffer","MissingKey","isFrameServerInjected","hasValidKey","decodedFrame","decryptFrame","decryptionSuccess","InvalidKey","decryptionFailure","initialMaterial","ratchetOpts","ratchetCount","encryptedData","newUint8","ivLength","cipherTextStart","cipherTextLength","plainText","decrypt","RTCEncodedAudioFrame","ratchetedKeySet","newMaterial","ratchetKey","setKeySet","setCurrentKeyIndex","setKeyFromMaterial","ivView","DataView","has","Math","floor","random","sendCount","setUint32","detectedCodec","getVideoCodec","naluIndices","findNALUIndices","some","naluIndex","NALUType","SLICE_IDR","SLICE_NON_IDR","includes","parseNALUType","size","payloadType","result","start","pos","searchLength","end","startByte","kNaluTypeMask","trailerBytes","every","ParticipantKeyHandler","_hasValidKey","decryptionFailureCount","currentKeyIndex","cryptoKeyRing","fill","ratchetPromiseMap","resetKeyStatus","setKey","existingPromise","ratchetPromise","__awaiter","currentMaterial","KeyRatcheted","delete","emitRatchetEvent","participantCryptors","participantKeys","sharedKeyHandler","isEncryptionEnabled","useSharedKey","onmessage","ev","kind","ackMsg","enabled","postMessage","setEncryptionEnabled","cryptor","getTrackCryptor","readableStream","writableStream","pubCryptor","setSharedKey","getParticipantKeyHandler","unsetCryptorParticipant","forEach","cr","handleRatchetRequest","handleSifTrailer","keyHandler","getSharedKeyHandler","find","c","setupCryptorErrorEvents","emitRatchetedKeys","enable","msg","RTCTransformEvent","onrtctransform","event","transformer","handled","options"],"mappings":"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","x_google_ignoreList":[0,6]}